- 1 hstore kh√¥ng ph·∫£i l√† m·ªôt ki·ªÉu d·ªØ li·ªáu ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn (built-in) trong PostgreSQL theo m·∫∑c ƒë·ªãnh. N√≥ l√† m·ªôt extension (ph·∫ßn m·ªü r·ªông) m√† b·∫°n c·∫ßn ph·∫£i k√≠ch ho·∫°t (enable)
CREATE EXTENSION IF NOT EXISTS hstore;
CREATE TABLE books (
    id serial PRIMARY KEY,
    title VARCHAR(255),
    attr hstore 
);

- 1.1 Ki·ªÉu hstore l∆∞u gi√° tr·ªã theo ki·ªÉu key => value: INSERT INTO books (title, attr)
VALUES
(
'Winds Of Winter',
'"paperback" => "2403",
"publisher" => "Bantam Spectra/US & Voyager Books/UK",
"language"  => "English",
"ISBN-13"   => "978-1449370000",
"weight"    => "13.2 ounces"'
),
Ch·ªçn ra key mu·ªën l·∫•y value :SELECT attr -> 'ISBN-13' AS isbn
FROM books;

- 1.2 CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE users (
user_id SERIAL PRIMARY KEY,
username VARCHAR(50) UNIQUE NOT NULL,
email VARCHAR(100) UNIQUE NOT NULL,
registration_uuid UUID DEFAULT gen_random_uuid(),
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
Extension uuid-ossp cung c·∫•p c√°c h√†m ƒë·ªÉ t·∫°o UUID (Universally Unique Identifier), bao g·ªìm gen_random_uuid()

- 1.3 pg_stat_statements l√† m·ªôt extension r·∫•t h·ªØu √≠ch cung c·∫•p th·ªëng k√™ v·ªÅ vi·ªác th·ª±c thi t·∫•t c·∫£ c√°c c√¢u l·ªánh SQL ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi m√°y ch·ªß PostgreSQL
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
SELECT count(*) FROM pg_stat_statements;

- 1.4 S·ª≠ d·ª•ng Extension pg_cron:
ƒê√¢y l√† c√°ch g·∫ßn gi·ªëng nh·∫•t v·ªõi MySQL Events v·ªÅ m·∫∑t qu·∫£n l√Ω b√™n trong c∆° s·ªü d·ªØ li·ªáu.
pg_cron l√† m·ªôt extension (ph·∫ßn m·ªü r·ªông) b·∫°n c·∫ßn c√†i ƒë·∫∑t v√† k√≠ch ho·∫°t.
N√≥ cho ph√©p b·∫°n l√™n l·ªãch ch·∫°y c√°c c√¢u l·ªánh SQL (nh∆∞ UPDATE, INSERT, DELETE, g·ªçi h√†m FUNCTION, VACUUM, v.v.) tr·ª±c ti·∫øp t·ª´ b√™n trong PostgreSQL b·∫±ng c√∫ ph√°p t∆∞∆°ng t·ª± nh∆∞ cron c·ªßa Linux.
V√≠ d·ª•: L√™n l·ªãch ch·∫°y m·ªôt function my_nightly_job() v√†o 3:30 s√°ng h√†ng ng√†y:
-- (Sau khi ƒë√£ c√†i ƒë·∫∑t v√† c·∫•u h√¨nh pg_cron)
SELECT cron.schedule('nightly-job', '30 3 * * *', 'SELECT my_nightly_job()');

ƒê√¢y th∆∞·ªùng l√† l·ª±a ch·ªçn ∆∞u ti√™n n·∫øu b·∫°n mu·ªën qu·∫£n l√Ω l·ªãch tr√¨nh ho√†n to√†n b·∫±ng SQL v√† t√°c v·ª• ch·ªâ li√™n quan ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu.

- 2 Gi·∫£ s·ª≠ ch√∫ng ta c√≥ b·∫£ng sales v·ªõi c√°c c·ªôt brand, segment, v√† quantity nh∆∞ sau:

brand	segment	quantity
Apple	Mobile	100
Samsung	Mobile	150
Apple	Laptop	80
Dell	Laptop	120
Apple	Mobile	50
Samsung	Tablet	70
Dell	Desktop	90


SELECT brand, segment, SUM (quantity) FROM sales GROUP BY GROUPING SETS ( (brand, segment), (brand), (segment), () );

K·∫øt qu·∫£ trong PostgrSQL:

brand	segment	sum
Apple	Mobile	150
Samsung	Mobile	150
Apple	Laptop	80
Dell	Laptop	120
Samsung	Tablet	70
Dell	Desktop	90
Apple	NULL	230
Samsung	NULL	220
Dell	NULL	210
NULL	Mobile	250
NULL	Laptop	200
NULL	Tablet	70
NULL	Desktop	90
NULL	NULL	610

Gi·∫£i th√≠ch k·∫øt qu·∫£ PostgreSQL:



C√¢u l·ªánh MySQL t∆∞∆°ng ƒë∆∞∆°ng:


SELECT brand,segment,
SUM (quantity)
FROM
sales
GROUP BY
brand, segment

UNION ALL

SELECT
brand,
NULL AS segment,
SUM (quantity)
FROM
sales
GROUP BY
brand

UNION ALL

SELECT
NULL AS brand,
segment,
SUM (quantity)
FROM
sales
GROUP BY
segment

UNION ALL

SELECT
NULL AS brand,
NULL AS segment,
SUM (quantity)
FROM
sales;


K·∫øt qu·∫£ trong MySQL (t∆∞∆°ng ƒë∆∞∆°ng):

MySQL s·∫Ω tr·∫£ v·ªÅ m·ªôt t·∫≠p k·∫øt qu·∫£ c√≥ c√°c h√†ng t∆∞∆°ng t·ª± nh∆∞ tr√™n, ch·ªâ l√† th·ª© t·ª± c√°c h√†ng c√≥ th·ªÉ kh√°c nhau do UNION ALL kh√¥ng ƒë·∫£m b·∫£o th·ª© t·ª±.

brand	segment	SUM(quantity)
Apple	Mobile	150
Samsung	Mobile	150
Apple	Laptop	80
Dell	Laptop	120
Samsung	Tablet	70
Dell	Desktop	90
Apple	NULL	230
Samsung	NULL	220
Dell	NULL	210
NULL	Mobile	250
NULL	Laptop	200
NULL	Tablet	70
NULL	Desktop	90
NULL	NULL	610

L∆∞u √Ω v·ªÅ MySQL:

Th·ª© t·ª± c√°c h√†ng trong k·∫øt qu·∫£ c·ªßa MySQL c√≥ th·ªÉ kh√°c v·ªõi PostgreSQL v√¨ UNION ALL kh√¥ng duy tr√¨ th·ª© t·ª±. N·∫øu b·∫°n c·∫ßn m·ªôt th·ª© t·ª± c·ª• th·ªÉ, b·∫°n c√≥ th·ªÉ th√™m m·ªánh ƒë·ªÅ ORDER BY v√†o t·ª´ng c√¢u l·ªánh SELECT v√† c√≥ th·ªÉ th√™m m·ªôt c·ªôt ph·ª• ƒë·ªÉ ch·ªâ ƒë·ªãnh lo·∫°i nh√≥m tr∆∞·ªõc khi UNION ALL ƒë·ªÉ c√≥ th·ªÉ s·∫Øp x·∫øp k·∫øt qu·∫£ cu·ªëi c√πng. 
Tuy nhi√™n, ƒëi·ªÅu n√†y l√†m tƒÉng th√™m s·ª± ph·ª©c t·∫°p cho c√¢u l·ªánh.
V√≠ d·ª• n√†y l√†m r√µ c√°ch GROUPING SETS trong PostgreSQL cho ph√©p b·∫°n ƒë·ªãnh nghƒ©a nhi·ªÅu c√°ch nh√≥m d·ªØ li·ªáu trong m·ªôt truy v·∫•n duy nh·∫•t, t·∫°o ra m·ªôt t·∫≠p k·∫øt qu·∫£ t·ªïng h·ª£p ƒëa chi·ªÅu. N√≥ c≈©ng minh h·ªça c√°ch b·∫°n c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ t∆∞∆°ng t·ª± trong MySQL b·∫±ng c√°ch s·ª≠ d·ª•ng UNION ALL v√† nhi·ªÅu c√¢u l·ªánh GROUP BY ri√™ng bi·ªát.

- 3 Tuy·ªát v·ªùi, d·ª±a tr√™n h∆∞·ªõng d·∫´n v·ªÅ CUBE trong PostgreSQL t·ª´ link b·∫°n cung c·∫•p, ƒë√¢y l√† v√≠ d·ª• c·ª• th·ªÉ v·ªõi d·ªØ li·ªáu m·∫´u cho b·∫£ng sales v√† k·∫øt qu·∫£ c·ªßa c√¢u l·ªánh SELECT ... GROUP BY CUBE(...).

D·ªØ li·ªáu m·∫´u cho b·∫£ng sales:

Gi·∫£ s·ª≠ ch√∫ng ta v·∫´n s·ª≠ d·ª•ng b·∫£ng sales v·ªõi c√°c c·ªôt brand, segment, v√† quantity:

brand	segment	quantity
Apple	Mobile	100
Samsung	Mobile	150
Apple	Laptop	80
Dell	Laptop	120
Apple	Mobile	50
Samsung	Tablet	70
Dell	Desktop	90

C√¢u l·ªánh PostgreSQL s·ª≠ d·ª•ng CUBE:

sql SELECT brand, segment, SUM (quantity) FROM sales GROUP BY CUBE (brand, segment) ORDER BY brand, segment; -- Th√™m ORDER BY ƒë·ªÉ d·ªÖ ƒë·ªçc

K·∫øt qu·∫£ trong PostgreSQL:

brand	segment	sum
NULL	NULL	610
NULL	Desktop	90
NULL	Laptop	200
NULL	Mobile	250
NULL	Tablet	70
Apple	NULL	230
Apple	Laptop	80
Apple	Mobile	150
Apple	Tablet	NULL
Dell	NULL	210
Dell	Desktop	90
Dell	Laptop	120
Dell	Mobile	NULL
Dell	Tablet	NULL
Samsung	NULL	220
Samsung	Mobile	150
Samsung	Tablet	70
Samsung	Laptop	NULL

Gi·∫£i th√≠ch k·∫øt qu·∫£ PostgreSQL v·ªõi CUBE(brand, segment):

M·ªánh ƒë·ªÅ GROUP BY CUBE (brand, segment) t·∫°o ra c√°c nh√≥m cho t·∫•t c·∫£ c√°c t·ªï h·ª£p c√≥ th·ªÉ c·ªßa c√°c c·ªôt brand v√† segment, bao g·ªìm c·∫£ c√°c t·ªïng h·ª£p tr√™n t·ª´ng c·ªôt ri√™ng l·∫ª v√† t·ªïng h·ª£p to√†n b·ªô:

So s√°nh v·ªõi GROUPING SETS:

C√¢u l·ªánh tr√™n t∆∞∆°ng ƒë∆∞∆°ng v·ªõi vi·ªác s·ª≠ d·ª•ng GROUPING SETS nh∆∞ sau:

sql SELECT brand, segment, SUM (quantity) FROM sales GROUP BY GROUPING SETS ( (brand, segment), (brand), (segment), () ) ORDER BY brand, segment;

Tuy nhi√™n, CUBE(brand, segment) t·ª± ƒë·ªông t·∫°o ra t·∫•t c·∫£ 2^n t·ªï h·ª£p nh√≥m c√≥ th·ªÉ (trong tr∆∞·ªùng h·ª£p n√†y n=2, n√™n c√≥ 2^2 = 4 t·ªï h·ª£p: (brand, segment), (brand), (segment), ()). ƒêi·ªÅu n√†y ti·ªán l·ª£i khi b·∫°n mu·ªën ph√¢n t√≠ch d·ªØ li·ªáu theo t·∫•t c·∫£ c√°c m·ª©c ƒë·ªô t·ªïng h·ª£p c√≥ th·ªÉ c·ªßa m·ªôt t·∫≠p h·ª£p c√°c c·ªôt.

L∆∞u √Ω:

Trong k·∫øt qu·∫£, b·∫°n s·∫Ω th·∫•y c√°c h√†ng c√≥ gi√° tr·ªã NULL ·ªü c√°c c·ªôt nh√≥m. NULL ·ªü ƒë√¢y kh√¥ng c√≥ nghƒ©a l√† gi√° tr·ªã th·ª±c t·∫ø l√† null trong d·ªØ li·ªáu g·ªëc, m√† n√≥ bi·ªÉu th·ªã r·∫±ng h√†ng ƒë√≥ l√† k·∫øt qu·∫£ c·ªßa vi·ªác t·ªïng h·ª£p tr√™n c√°c nh√≥m m√† c·ªôt ƒë√≥ kh√¥ng ƒë∆∞·ª£c xem x√©t (v√≠ d·ª•: h√†ng Apple | NULL | 230 l√† t·ªïng c·ªßa t·∫•t c·∫£ c√°c segment cho brand Apple).

ORDER BY brand, segment ƒë∆∞·ª£c th√™m v√†o ch·ªâ ƒë·ªÉ l√†m cho k·∫øt qu·∫£ d·ªÖ ƒë·ªçc v√† hi·ªÉu h∆°n.

- 4  SELECT brand, segment, SUM (quantity) FROM sales GROUP BY ROLLUP (brand, segment) ORDER BY brand, segment NULLS FIRST; 
K·∫øt qu·∫£ trong PostgreSQL:
brand	segment	sum
NULL	NULL	610
Apple	NULL	230
Apple	Laptop	80
Apple	Mobile	150
Dell	NULL	210
Dell	Desktop	90
Dell	Laptop	120
Samsung	NULL	220
Samsung	Mobile	150
Samsung	Tablet	70
Gi·∫£i th√≠ch k·∫øt qu·∫£ PostgreSQL v·ªõi ROLLUP(brand, segment):
M·ªánh ƒë·ªÅ GROUP BY ROLLUP (brand, segment) t·∫°o ra c√°c nh√≥m t·ªïng h·ª£p theo m·ªôt th·ª© b·∫≠c t·ª´ tr√°i sang ph·∫£i c·ªßa c√°c c·ªôt ƒë∆∞·ª£c li·ªát k√™:
T·ªïng h·ª£p theo t·∫•t c·∫£ c√°c c·ªôt: (brand, segment) - t∆∞∆°ng t·ª± nh∆∞ GROUP BY brand, segment.
T·ªïng h·ª£p theo c·ªôt ƒë·∫ßu ti√™n: (brand) - b·ªè qua c√°c c·ªôt theo sau.
T·ªïng h·ª£p to√†n b·ªô: () - b·ªè qua t·∫•t c·∫£ c√°c c·ªôt ƒë∆∞·ª£c li·ªát k√™ trong ROLLUP.
L∆∞u √Ω quan tr·ªçng v·ªÅ th·ª© t·ª±: Th·ª© t·ª± c·ªßa c√°c c·ªôt trong m·ªánh ƒë·ªÅ ROLLUP r·∫•t quan tr·ªçng. ROLLUP (brand, segment) s·∫Ω t·∫°o ra c√°c t·ªïng h·ª£p theo th·ª© t·ª±: (brand, segment), (brand), v√† (). 
N·∫øu b·∫°n ƒë·ªïi th·ª© t·ª± th√†nh ROLLUP (segment, brand), c√°c t·ªïng h·ª£p s·∫Ω theo (segment, brand), (segment), v√† ().
ROLLUP trong PostgreSQL v√† WITH ROLLUP trong MySQL ƒë·ªÅu cung c·∫•p kh·∫£ nƒÉng t·∫°o c√°c h√†ng t·ªïng h·ª£p theo m·ªôt th·ª© b·∫≠c x√°c ƒë·ªãnh b·ªüi th·ª© t·ª± c√°c c·ªôt trong m·ªánh ƒë·ªÅ GROUP BY.

- 5 Gi·∫£ s·ª≠ ch√∫ng ta c√≥ hai b·∫£ng:

B·∫£ng products:

product_id	product_name	price
1	Laptop Pro	1200
2	Mouse Wired	25
3	Keyboard RGB	75
4	Monitor 27"	300

B·∫£ng sales_info:

sale_id	product_id	discount_rate
101	1	0.10
102	3	0.05
103	1	0.15
104	4	0.08

M·ª•c ti√™u: Ch√∫ng ta mu·ªën c·∫≠p nh·∫≠t gi√° trong b·∫£ng products b·∫±ng c√°ch gi·∫£m gi√° d·ª±a tr√™n discount_rate trong b·∫£ng sales_info cho nh·ªØng s·∫£n ph·∫©m c√≥ trong c·∫£ hai b·∫£ng.

C√¢u l·ªánh PostgreSQL s·ª≠ d·ª•ng UPDATE v·ªõi JOIN:

UPDATE products
SET price = products.price * (1 - sales_info.discount_rate)
FROM sales_info
WHERE products.product_id = sales_info.product_id;


Gi·∫£i th√≠ch c√¢u l·ªánh PostgreSQL:

UPDATE products: Ch·ªâ ƒë·ªãnh b·∫£ng m√† ch√∫ng ta mu·ªën c·∫≠p nh·∫≠t (products).

SET price = products.price * (1 - sales_info.discount_rate): X√°c ƒë·ªãnh c·ªôt c·∫ßn c·∫≠p nh·∫≠t (price) v√† c√°ch t√≠nh gi√° tr·ªã m·ªõi. Ch√∫ng ta l·∫•y gi√° hi·ªán t·∫°i t·ª´ b·∫£ng products v√† nh√¢n v·ªõi (1 - discount_rate) l·∫•y t·ª´ b·∫£ng sales_info.

FROM sales_info: Ch·ªâ ƒë·ªãnh b·∫£ng m√† ch√∫ng ta s·∫Ω tham gia (sales_info).

WHERE products.product_id = sales_info.product_id: ƒêi·ªÅu ki·ªán JOIN ƒë·ªÉ li√™n k·∫øt c√°c h√†ng t·ª´ products v√† sales_info d·ª±a tr√™n c·ªôt product_id. Ch·ªâ nh·ªØng s·∫£n ph·∫©m c√≥ product_id tr√πng kh·ªõp trong c·∫£ hai b·∫£ng m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t.

K·∫øt qu·∫£ sau khi ch·∫°y c√¢u l·ªánh PostgreSQL:

B·∫£ng products sau khi c·∫≠p nh·∫≠t:

product_id	product_name	price
1	Laptop Pro	1020.00
2	Mouse Wired	25.00
3	Keyboard RGB	71.25
4	Monitor 27"	276.00

L∆∞u √Ω: S·∫£n ph·∫©m c√≥ product_id = 2 (Mouse Wired) kh√¥ng c√≥ b·∫£n ghi t∆∞∆°ng ·ª©ng trong sales_info, v√¨ v·∫≠y gi√° c·ªßa n√≥ kh√¥ng b·ªã thay ƒë·ªïi. N·∫øu c√≥ nhi·ªÅu b·∫£n ghi trong sales_info cho c√πng m·ªôt product_id, h√†nh vi c·∫≠p nh·∫≠t c√≥ th·ªÉ kh√¥ng x√°c ƒë·ªãnh (trong v√≠ d·ª• n√†y, product_id = 1 xu·∫•t hi·ªán hai l·∫ßn trong sales_info, nh∆∞ng c√¢u l·ªánh s·∫Ω ch·ªâ th·ª±c hi·ªán c·∫≠p nh·∫≠t d·ª±a tr√™n vi·ªác c√≥ m·ªôt h√†ng kh·ªõp, c√≥ th·ªÉ l√† h√†ng ƒë·∫ßu ti√™n t√¨m th·∫•y). ƒê·ªÉ ki·ªÉm so√°t vi·ªác n√†y t·ªët h∆°n, b·∫°n c√≥ th·ªÉ c·∫ßn c√°c ƒëi·ªÅu ki·ªán JOIN ph·ª©c t·∫°p h∆°n ho·∫∑c s·ª≠ d·ª•ng c√°c ph∆∞∆°ng ph√°p kh√°c.

UPDATE JOIN t∆∞∆°ng t·ª± trong MySQL:

MySQL cung c·∫•p c√∫ ph√°p UPDATE v·ªõi JOIN tr·ª±c ti·∫øp s·ª≠ d·ª•ng t·ª´ kh√≥a JOIN (ho·∫∑c INNER JOIN, LEFT JOIN, v.v.) trong m·ªánh ƒë·ªÅ UPDATE:

UPDATE products
INNER JOIN sales_info ON products.product_id = sales_info.product_id
SET products.price = products.price * (1 - sales_info.discount_rate);

K·∫øt lu·∫≠n:

PostgreSQL v√† MySQL ƒë·ªÅu h·ªó tr·ª£ vi·ªác c·∫≠p nh·∫≠t d·ªØ li·ªáu trong m·ªôt b·∫£ng d·ª±a tr√™n d·ªØ li·ªáu t·ª´ m·ªôt b·∫£ng kh√°c th√¥ng qua ph√©p JOIN.

PostgreSQL s·ª≠ d·ª•ng c√∫ ph√°p UPDATE target_table SET ... FROM joined_table WHERE join_condition.

MySQL s·ª≠ d·ª•ng c√∫ ph√°p UPDATE target_table INNER JOIN joined_table ON join_condition SET ....

- 6 D·ªØ li·ªáu m·∫´u:

Gi·∫£ s·ª≠ ch√∫ng ta c√≥ b·∫£ng inventory v·ªõi c√°c c·ªôt product_id, quantity, v√† last_updated:

product_id	quantity	last_updated
1	100	2023-10-26 10:00:00
2	50	2023-10-26 10:00:00
3	75	2023-10-26 10:00:00

Ch√∫ng ta mu·ªën th·ª±c hi·ªán c√°c thao t√°c sau:

Th√™m m·ªôt s·∫£n ph·∫©m m·ªõi (product_id = 4) v·ªõi s·ªë l∆∞·ª£ng ban ƒë·∫ßu.

C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng cho m·ªôt s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i (product_id = 1).

C√¢u l·ªánh PostgreSQL s·ª≠ d·ª•ng INSERT ON CONFLICT (UPSERT):

ƒê·ªÉ s·ª≠ d·ª•ng ON CONFLICT, ch√∫ng ta c·∫ßn m·ªôt r√†ng bu·ªôc UNIQUE tr√™n c·ªôt m√† ch√∫ng ta mu·ªën ki·ªÉm tra xung ƒë·ªôt. Trong tr∆∞·ªùng h·ª£p n√†y, product_id n√™n l√† UNIQUE. Ch√∫ng ta c√≥ th·ªÉ t·∫°o r√†ng bu·ªôc n√†y n·∫øu n√≥ ch∆∞a t·ªìn t·∫°i:

sql ALTER TABLE inventory ADD CONSTRAINT inventory_product_id_unique UNIQUE (product_id);

B√¢y gi·ªù, ch√∫ng ta c√≥ th·ªÉ th·ª±c hi·ªán UPSERT:

-- Th√™m s·∫£n ph·∫©m m·ªõi (product_id = 4)
INSERT INTO inventory (product_id, quantity, last_updated)
VALUES (4, 20, NOW())
ON CONFLICT (product_id) DO NOTHING;
-- V√¨ product_id = 4 ch∆∞a t·ªìn t·∫°i, h√†ng n√†y s·∫Ω ƒë∆∞·ª£c th√™m v√†o.

-- C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i (product_id = 1)
INSERT INTO inventory (product_id, quantity, last_updated)
VALUES (1, 120, NOW())
ON CONFLICT (product_id) DO UPDATE SET
quantity = EXCLUDED.quantity,
last_updated = EXCLUDED.last_updated;
-- V√¨ product_id = 1 ƒë√£ t·ªìn t·∫°i, h√†ng s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
-- EXCLUDED ch·ª©a c√°c gi√° tr·ªã ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t cho h√†ng m·ªõi.

Gi·∫£i th√≠ch c√¢u l·ªánh PostgreSQL:

INSERT INTO inventory (product_id, quantity, last_updated) VALUES (...): ƒê√¢y l√† c√¢u l·ªánh INSERT th√¥ng th∆∞·ªùng ƒë·ªÉ ch√®n m·ªôt h√†ng m·ªõi v√†o b·∫£ng inventory.

ON CONFLICT (product_id): ƒêi·ªÅu kho·∫£n n√†y ch·ªâ ƒë·ªãnh c·ªôt m√† PostgreSQL s·∫Ω ki·ªÉm tra xung ƒë·ªôt UNIQUE. N·∫øu m·ªôt h√†ng v·ªõi product_id ƒë√£ t·ªìn t·∫°i, h√†nh ƒë·ªông sau DO s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán.

DO NOTHING: N·∫øu x·∫£y ra xung ƒë·ªôt (t·ª©c l√† product_id ƒë√£ t·ªìn t·∫°i), kh√¥ng th·ª±c hi·ªán h√†nh ƒë·ªông g√¨ c·∫£. Trong v√≠ d·ª• ƒë·∫ßu ti√™n, n·∫øu product_id = 4 ƒë√£ t·ªìn t·∫°i (ƒëi·ªÅu n√†y kh√¥ng x·∫£y ra trong d·ªØ li·ªáu ban ƒë·∫ßu), h√†ng m·ªõi s·∫Ω kh√¥ng ƒë∆∞·ª£c th√™m v√†o v√† h√†ng c≈© s·∫Ω kh√¥ng b·ªã thay ƒë·ªïi.

DO UPDATE SET quantity = EXCLUDED.quantity, last_updated = EXCLUDED.last_updated: N·∫øu x·∫£y ra xung ƒë·ªôt (t·ª©c l√† product_id ƒë√£ t·ªìn t·∫°i), h√£y th·ª±c hi·ªán l·ªánh UPDATE tr√™n h√†ng hi·ªán c√≥.

EXCLUDED l√† m·ªôt b·∫£ng ·∫£o ch·ª©a c√°c gi√° tr·ªã ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t trong c√¢u l·ªánh INSERT.

quantity = EXCLUDED.quantity c·∫≠p nh·∫≠t c·ªôt quantity c·ªßa h√†ng hi·ªán c√≥ b·∫±ng gi√° tr·ªã quantity t·ª´ c√¢u l·ªánh INSERT.

last_updated = EXCLUDED.last_updated t∆∞∆°ng t·ª±, c·∫≠p nh·∫≠t d·∫•u th·ªùi gian.

K·∫øt qu·∫£ sau khi ch·∫°y c√¢u l·ªánh PostgreSQL:

B·∫£ng inventory sau khi th·ª±c hi·ªán UPSERT:

product_id	quantity	last_updated
1	120	2023-10-27 08:00:00
2	50	2023-10-26 10:00:00
3	75	2023-10-26 10:00:00
4	20	2023-10-27 08:00:00

(L∆∞u √Ω: NOW() s·∫Ω tr·∫£ v·ªÅ th·ªùi gian hi·ªán t·∫°i khi b·∫°n ch·∫°y c√¢u l·ªánh, n√™n d·∫•u th·ªùi gian th·ª±c t·∫ø s·∫Ω kh√°c v·ªõi v√≠ d·ª• ban ƒë·∫ßu).

UPSERT t∆∞∆°ng t·ª± trong MySQL:

MySQL kh√¥ng c√≥ c√∫ ph√°p ON CONFLICT tr·ª±c ti·∫øp nh∆∞ PostgreSQL. Tuy nhi√™n, b·∫°n c√≥ th·ªÉ th·ª±c hi·ªán h√†nh vi UPSERT t∆∞∆°ng t·ª± b·∫±ng c√°ch s·ª≠ d·ª•ng c√∫ ph√°p INSERT ... ON DUPLICATE KEY UPDATE. ƒêi·ªÅu n√†y y√™u c·∫ßu b·∫£ng ph·∫£i c√≥ m·ªôt kh√≥a UNIQUE ho·∫∑c PRIMARY KEY tr√™n c·ªôt (ho·∫∑c t·ªï h·ª£p c·ªôt) m√† b·∫°n mu·ªën ki·ªÉm tra tr√πng l·∫∑p.

S·ª≠ d·ª•ng l·∫°i b·∫£ng inventory v√† ƒë·∫£m b·∫£o product_id l√† UNIQUE (n·∫øu ch∆∞a c√≥, h√£y t·∫°o index UNIQUE):

sql ALTER TABLE inventory ADD UNIQUE INDEX inventory_product_id_unique (product_id);

B√¢y gi·ªù, b·∫°n c√≥ th·ªÉ th·ª±c hi·ªán UPSERT trong MySQL nh∆∞ sau:

-- Th√™m s·∫£n ph·∫©m m·ªõi (product_id = 4) ho·∫∑c kh√¥ng l√†m g√¨ n·∫øu ƒë√£ t·ªìn t·∫°i
INSERT IGNORE INTO inventory (product_id, quantity, last_updated)
VALUES (4, 20, NOW());
-- INSERT IGNORE s·∫Ω b·ªè qua n·∫øu c√≥ l·ªói kh√≥a tr√πng l·∫∑p.

-- Th√™m s·∫£n ph·∫©m m·ªõi (product_id = 1) ho·∫∑c c·∫≠p nh·∫≠t n·∫øu ƒë√£ t·ªìn t·∫°i
INSERT INTO inventory (product_id, quantity, last_updated)
VALUES (1, 120, NOW())
ON DUPLICATE KEY UPDATE
quantity = VALUES(quantity),
last_updated = VALUES(last_updated);
-- N·∫øu product_id ƒë√£ t·ªìn t·∫°i, c√°c c·ªôt quantity v√† last_updated s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t
-- b·∫±ng c√°c gi√° tr·ªã ƒë∆∞·ª£c cung c·∫•p trong m·ªánh ƒë·ªÅ VALUES().

SELECT * FROM inventory;
``

Gi·∫£i th√≠ch c√¢u l·ªánh MySQL:

INSERT IGNORE INTO ...: N·∫øu b·∫°n c·ªë g·∫Øng ch√®n m·ªôt h√†ng c√≥ kh√≥a tr√πng l·∫∑p, MySQL s·∫Ω b·ªè qua l·ªói v√† h√†ng s·∫Ω kh√¥ng ƒë∆∞·ª£c ch√®n (v√† h√†ng c≈© s·∫Ω kh√¥ng b·ªã thay ƒë·ªïi). ƒêi·ªÅu n√†y t∆∞∆°ng ƒë∆∞∆°ng v·ªõi ON CONFLICT DO NOTHING trong PostgreSQL.

INSERT INTO ... ON DUPLICATE KEY UPDATE ...: N·∫øu b·∫°n c·ªë g·∫Øng ch√®n m·ªôt h√†ng g√¢y ra l·ªói tr√πng l·∫∑p kh√≥a (d·ª±a tr√™n kh√≥a UNIQUE ho·∫∑c PRIMARY KEY), MySQL s·∫Ω kh√¥ng b√°o l·ªói m√† thay v√†o ƒë√≥ s·∫Ω th·ª±c hi·ªán m·ªánh ƒë·ªÅ UPDATE.

VALUES(column_name): Trong m·ªánh ƒë·ªÅ ON DUPLICATE KEY UPDATE, VALUES(column_name) tham chi·∫øu ƒë·∫øn gi√° tr·ªã m√† b·∫°n ƒë√£ c·ªë g·∫Øng ch√®n cho column_name trong m·ªánh ƒë·ªÅ INSERT.

K·∫øt qu·∫£ sau khi ch·∫°y c√¢u l·ªánh MySQL (v·ªõi d·ªØ li·ªáu m·∫´u t∆∞∆°ng t·ª±):

B·∫£ng inventory sau khi th·ª±c hi·ªán UPSERT trong MySQL s·∫Ω cho k·∫øt qu·∫£ t∆∞∆°ng t·ª± nh∆∞ trong PostgreSQL:

product_id	quantity	last_updated
1	120	2023-10-27 08:00:00
2	50	2023-10-26 10:00:00
3	75	2023-10-26 10:00:00
4	20	2023-10-27 08:00:00

K·∫øt lu·∫≠n:

PostgreSQL cung c·∫•p c√∫ ph√°p INSERT ... ON CONFLICT ... DO NOTHING/UPDATE cho thao t√°c UPSERT, l√† m·ªôt ph·∫ßn c·ªßa chu·∫©n SQL g·∫ßn ƒë√¢y.

MySQL cung c·∫•p INSERT IGNORE INTO cho h√†nh vi "insert or do nothing" v√† INSERT ... ON DUPLICATE KEY UPDATE cho h√†nh vi "insert or update" d·ª±a tr√™n kh√≥a UNIQUE ho·∫∑c PRIMARY KEY.

- 7.1 TEMPORARY TABLE AS SELECT l√† g√¨?
üìå Kh√°i ni·ªám:
T·∫°o m·ªôt b·∫£ng t·∫°m th·ªùi t·ª´ m·ªôt truy v·∫•n SELECT.

B·∫£ng ch·ªâ t·ªìn t·∫°i trong phi√™n l√†m vi·ªác hi·ªán t·∫°i (session).

Khi session k·∫øt th√∫c (ng·∫Øt k·∫øt n·ªëi), b·∫£ng s·∫Ω t·ª± ƒë·ªông b·ªã x√≥a.

‚úÖ Khi n√†o n√™n d√πng:
Khi b·∫°n mu·ªën l∆∞u d·ªØ li·ªáu t·∫°m th·ªùi, v√≠ d·ª•: x·ª≠ l√Ω trung gian, ph√¢n t√≠ch b√°o c√°o, th·ªëng k√™,...

Tr√°nh ·∫£nh h∆∞·ªüng ƒë·∫øn d·ªØ li·ªáu th·∫≠t trong h·ªá th·ªëng.

CREATE TEMPORARY TABLE temp_users AS
SELECT * FROM users WHERE age > 30;

- 7.2  UNLOGGED TABLE l√† g√¨?
üìå Kh√°i ni·ªám:
L√† lo·∫°i b·∫£ng kh√¥ng ghi log (WAL - Write-Ahead Logging) nh∆∞ c√°c b·∫£ng b√¨nh th∆∞·ªùng trong PostgreSQL.

V√¨ kh√¥ng log, n√™n hi·ªáu nƒÉng ghi/ƒë·ªçc r·∫•t nhanh.

Nh∆∞ng n·∫øu h·ªá th·ªëng b·ªã t·∫Øt ƒë·ªôt ng·ªôt (crash), d·ªØ li·ªáu trong b·∫£ng n√†y s·∫Ω m·∫•t.

‚úÖ Khi n√†o n√™n d√πng:
D√πng trong c√°c t√°c v·ª• c·∫ßn x·ª≠ l√Ω r·∫•t nhanh, kh√¥ng c·∫ßn ƒë·∫£m b·∫£o d·ªØ li·ªáu t·ªìn t·∫°i sau crash:

ETL (tr√≠ch xu·∫•t d·ªØ li·ªáu - chuy·ªÉn ƒë·ªïi - t·∫£i l√™n)

T·∫°m th·ªùi l∆∞u d·ªØ li·ªáu cho b√°o c√°o

Ph√¢n t√≠ch log, audit t·∫°m
CREATE UNLOGGED TABLE fast_buffer AS
SELECT * FROM big_table WHERE status = 'active';

- 8 GENERATED ALWAYS AS IDENTITY m√† kh√¥ng c√≥ t√πy ch·ªçn n√†o kh√°c, n√≥ s·∫Ω b·∫Øt ƒë·∫ßu t·ª´ 1 v√† tƒÉng d·∫ßn 1.
CREATE TABLE products (
    id INT GENERATED ALWAYS AS IDENTITY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10, 2)
);
CREATE TABLE categories (
    id INT GENERATED ALWAYS AS IDENTITY (START WITH 100 INCREMENT BY 10),
    name VARCHAR(50) NOT NULL
);
 id  |    name
-----+------------
 100 | Electronics
 110 | Books
(2 rows)

- 9 Composite Type:
CREATE TYPE address AS (
    street VARCHAR(100),
    city VARCHAR(50),
    postal_code VARCHAR(10)
);
Enum Type:
CREATE TYPE order_status AS ENUM ('pending', 'processing', 'shipped', 'delivered', 'cancelled');
Domain Type:
CREATE DOMAIN email AS VARCHAR(255) CHECK (VALUE LIKE '%@%.%');
CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    shipping_address address,
    billing_address address,
    order_status order_status,
    contact_email email
);
PostgreSQL cung c·∫•p m·ªôt h·ªá th·ªëng m·∫°nh m·∫Ω cho vi·ªác ƒë·ªãnh nghƒ©a c√°c ki·ªÉu d·ªØ li·ªáu do ng∆∞·ªùi d√πng, bao g·ªìm Composite Types, Enum Types v√† Domain Types.
MySQL c√≥ h·ªó tr·ª£ cho Enum Types v√† Set Types

- 10.1 SELECT 
    brand, 
    segment, 
    CASE 
        WHEN quantity ~ '^[0-9]+$' THEN quantity::INTEGER 
        ELSE NULL 
    END AS quantity_int
FROM sales;
L·ªánh n√†y ch·ªâ √©p ki·ªÉu th√†nh INTEGER n·∫øu quantity ch·ªâ ch·ª©a c√°c ch·ªØ s·ªë (ƒë∆∞·ª£c ki·ªÉm tra b·∫±ng bi·ªÉu th·ª©c ch√≠nh quy ^[0-9]+$). N·∫øu kh√¥ng, n√≥ s·∫Ω tr·∫£ v·ªÅ NULL.

- 11 SELECT attr -> 'publisher'
FROM books
WHERE attr -> 'publisher' ILIKE '%bantam%';
ILIKE '%bantam%': Th·ª±c hi·ªán so s√°nh kh√¥ng ph√¢n bi·ªát ch·ªØ hoa ch·ªØ th∆∞·ªùng ƒë·ªÉ xem gi√° tr·ªã ƒë√£ tr√≠ch xu·∫•t c√≥ ch·ª©a chu·ªói "bantam" hay kh√¥ng (s·ª≠ d·ª•ng k√Ω t·ª± % l√†m k√Ω t·ª± ƒë·∫°i di·ªán cho b·∫•t k·ª≥ chu·ªói k√Ω t·ª± n√†o).

- 10.2 SELECT attr -> 'weight'
FROM books
WHERE (attr -> 'weight') IS DISTINCT FROM '13.2 ounces';
SELECT attr -> 'weight'
FROM books
WHERE (attr -> 'weight') IS NOT DISTINCT FROM '13.2 ounces';
IS DISTINCT FROM tr·∫£ v·ªÅ TRUE n·∫øu hai gi√° tr·ªã kh√°c nhau (bao g·ªìm c·∫£ tr∆∞·ªùng h·ª£p m·ªôt trong hai l√† NULL).
IS NOT DISTINCT FROM tr·∫£ v·ªÅ TRUE n·∫øu hai gi√° tr·ªã b·∫±ng nhau (bao g·ªìm c·∫£ tr∆∞·ªùng h·ª£p c·∫£ hai ƒë·ªÅu l√† NULL).

- 11 PostgreSQL:
Case-sensitive: SELECT * FROM books WHERE title ~ 'Win.*er';
Case-insensitive: SELECT * FROM books WHERE title ~* 'win.*er';
Kh√¥ng kh·ªõp (case-sensitive): SELECT * FROM books WHERE title !~ 'Win.*er';
Kh√¥ng kh·ªõp (case-insensitive): SELECT * FROM books WHERE title !~* 'win.*er';
MySQL:
Case-sensitive (c·∫ßn s·ª≠ d·ª•ng BINARY): SELECT * FROM books WHERE title REGEXP BINARY 'Win.*er';
Case-insensitive (m·∫∑c ƒë·ªãnh): SELECT * FROM books WHERE title REGEXP 'win.*er'; ho·∫∑c SELECT * FROM books WHERE title RLIKE 'win.*er';
Kh√¥ng kh·ªõp (case-sensitive): SELECT * FROM books WHERE title NOT REGEXP BINARY 'Win.*er';
Kh√¥ng kh·ªõp (case-insensitive): SELECT * FROM books WHERE title NOT REGEXP 'win.*er'; ho·∫∑c SELECT * FROM books WHERE title NOT RLIKE 'win.*er';
PostgreSQL	MySQL	Ch·ª©c nƒÉng	ƒê·ªô nh·∫°y ch·ªØ hoa
~	REGEXP BINARY	Kh·ªõp v·ªõi bi·ªÉu th·ª©c ch√≠nh quy	Case-sensitive
~*	REGEXP	Kh·ªõp v·ªõi bi·ªÉu th·ª©c ch√≠nh quy	Case-insensitive
!~	NOT REGEXP BINARY	Kh√¥ng kh·ªõp v·ªõi bi·ªÉu th·ª©c ch√≠nh quy	Case-sensitive
!~*	NOT REGEXP	Kh√¥ng kh·ªõp v·ªõi bi·ªÉu th·ª©c ch√≠nh quy	Case-insensitive

- 12 PostgreSQL hi·ªÉn th·ªã true v√† false cho ki·ªÉu BOOLEAN, trong khi MySQL hi·ªÉn th·ªã 0 v√† 1 (v√¨ n√≥ l√† TINYINT(1)).

- 13.1 CREATE TABLE articles (
article_id SERIAL PRIMARY KEY,
title VARCHAR(255) NOT NULL,
content TEXT,
tags TEXT[]
);

·ªû ƒë√¢y, tags TEXT[] ƒë·ªãnh nghƒ©a m·ªôt c·ªôt c√≥ t√™n tags l√† m·ªôt m·∫£ng c√°c chu·ªói vƒÉn b·∫£n.
Ch√®n d·ªØ li·ªáu v·ªõi gi√° tr·ªã m·∫£ng:
INSERT INTO articles (title, content, tags)
VALUES ('Introduction to Arrays in PostgreSQL', '...', '{"postgres", "arrays", "data modeling"}');
INSERT INTO articles (title, content, tags)
VALUES ('Web Development Best Practices', '...', '{"webdev", "practices", "performance", "security"}');
INSERT INTO articles (title, content, tags)
VALUES ('Cooking with Spices', '...', '{"cooking", "spices", "recipes"}');
INSERT INTO articles (title, content, tags)
VALUES ('Advanced SQL Queries', '...', '{"sql", "postgres", "advanced"}');

L∆∞u √Ω c√°ch c√°c gi√° tr·ªã m·∫£ng ƒë∆∞·ª£c nh·∫≠p, th∆∞·ªùng l√† trong d·∫•u ngo·∫∑c nh·ªçn {} v√† c√°c ph·∫ßn t·ª≠ ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y.
Truy v·∫•n d·ªØ li·ªáu v√† thao t√°c v·ªõi m·∫£ng:
L·∫•y c√°c b√†i vi·∫øt c√≥ ch·ª©a m·ªôt th·∫ª c·ª• th·ªÉ (s·ª≠ d·ª•ng to√°n t·ª≠ ANY):
SELECT title, tags
FROM articles
WHERE 'postgres' = ANY(tags);

C√¢u truy v·∫•n n√†y s·∫Ω tr·∫£ v·ªÅ c√°c b√†i vi·∫øt c√≥ ch·ª©a th·∫ª 'postgres'.
L·∫•y c√°c b√†i vi·∫øt c√≥ ch·ª©a t·∫•t c·∫£ c√°c th·∫ª c·ª• th·ªÉ (s·ª≠ d·ª•ng to√°n t·ª≠ @> - contains):
SELECT title, tags
FROM articles
WHERE tags @> '{"sql", "postgres"}';

C√¢u truy v·∫•n n√†y s·∫Ω tr·∫£ v·ªÅ c√°c b√†i vi·∫øt ch·ª©a c·∫£ th·∫ª 'sql' v√† 'postgres'.
L·∫•y s·ªë l∆∞·ª£ng th·∫ª cho m·ªói b√†i vi·∫øt (s·ª≠ d·ª•ng h√†m array_length):
SELECT title, array_length(tags, 1) AS number_of_tags
FROM articles;

Th√™m m·ªôt th·∫ª m·ªõi v√†o m·∫£ng (s·ª≠ d·ª•ng to√°n t·ª≠ || - concatenation):
UPDATE articles
SET tags = tags || '{"database"}'
WHERE title = 'Introduction to Arrays in PostgreSQL';

- 13.2 1. T·∫°o B·∫£ng v·ªõi M·∫£ng Hai Chi·ªÅu:
Ch√∫ng ta s·∫Ω t·∫°o m·ªôt b·∫£ng chess_boards ƒë·ªÉ l∆∞u tr·ªØ tr·∫°ng th√°i c·ªßa c√°c v√°n c·ªù. M·ªói tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c bi·ªÉu di·ªÖn b·∫±ng m·ªôt m·∫£ng 2 chi·ªÅu c√°c k√Ω t·ª±.
SQL
CREATE TABLE chess_boards (
board_id SERIAL PRIMARY KEY,
description VARCHAR(255),
board_state CHAR(1) [][8]
);
Gi·∫£i th√≠ch:
board_state CHAR(1) [][8]: ƒê·ªãnh nghƒ©a m·ªôt c·ªôt t√™n board_state l√† m·ªôt m·∫£ng hai chi·ªÅu.
CHAR(1): M·ªói ph·∫ßn t·ª≠ trong m·∫£ng s·∫Ω l√† m·ªôt k√Ω t·ª± ƒë∆°n (v√≠ d·ª•: 'r' cho rook, 'p' cho pawn, '.' cho √¥ tr·ªëng).
[][8]: Ch·ªâ ƒë·ªãnh r·∫±ng ƒë√¢y l√† m·ªôt m·∫£ng hai chi·ªÅu. K√≠ch th∆∞·ªõc c·ªßa chi·ªÅu th·ª© hai c·ªë ƒë·ªãnh l√† 8 (t∆∞·ª£ng tr∆∞ng cho 8 c·ªôt c·ªßa b√†n c·ªù). K√≠ch th∆∞·ªõc c·ªßa chi·ªÅu th·ª© nh·∫•t (s·ªë h√†ng) kh√¥ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh ·ªü ƒë√¢y, nh∆∞ng khi ch√®n d·ªØ li·ªáu, ch√∫ng ta s·∫Ω t·∫°o m·∫£ng 8x8.
2. Ch√®n D·ªØ li·ªáu v·ªõi M·∫£ng Hai Chi·ªÅu:
Ch√∫ng ta s·∫Ω ch√®n tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa m·ªôt v√°n c·ªù.
SQL
INSERT INTO chess_boards (description, board_state)
VALUES (
'Initial board state',
'{{'r','n','b','q','k','b','n','r'},
{'p','p','p','p','p','p','p','p'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'P','P','P','P','P','P','P','P'},
{'R','N','B','Q','K','B','N','R'}}'
);
Gi·∫£i th√≠ch:
C·∫•u tr√∫c c·ªßa m·∫£ng 2 chi·ªÅu ƒë∆∞·ª£c bi·ªÉu di·ªÖn b·∫±ng c√°c d·∫•u ngo·∫∑c nh·ªçn l·ªìng nhau.
C√°c h√†ng ƒë∆∞·ª£c bao quanh b·ªüi d·∫•u ngo·∫∑c nh·ªçn b√™n trong, v√† c√°c ph·∫ßn t·ª≠ trong m·ªói h√†ng ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y.
C√°c h√†ng ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y v√† to√†n b·ªô m·∫£ng ƒë∆∞·ª£c bao quanh b·ªüi d·∫•u ngo·∫∑c nh·ªçn b√™n ngo√†i c√πng.
3. Truy c·∫≠p Ph·∫ßn T·ª≠ M·∫£ng theo Ch·ªâ M·ª•c:
L·∫•y qu√¢n c·ªù ·ªü h√†ng 1, c·ªôt 1 (g√≥c tr√™n b√™n tr√°i, qu√¢n rook ƒëen) c·ªßa v√°n c·ªù ƒë·∫ßu ti√™n.
SQL
SELECT description, board_state [1][1] AS top_left_piece
FROM chess_boards
WHERE board_id = 1;
L·∫•y h√†ng th·ª© hai (c√°c qu√¢n pawn ƒëen) c·ªßa v√°n c·ªù ƒë·∫ßu ti√™n.
SQL
SELECT description, board_state [2] AS black_pawns
FROM chess_boards
WHERE board_id = 1;
L·∫•y m·ªôt slice c·ªßa h√†ng th·ª© hai (3 qu√¢n pawn ƒëen ƒë·∫ßu ti√™n).
SQL
SELECT description, board_state [2][1:3] AS first_three_black_pawns
FROM chess_boards
WHERE board_id = 1;
4. S·ª≠a ƒë·ªïi Ph·∫ßn T·ª≠ M·∫£ng theo Ch·ªâ M·ª•c:
Di chuy·ªÉn qu√¢n pawn ƒëen ·ªü h√†ng 2, c·ªôt 3 l√™n m·ªôt √¥ (h√†ng 3, c·ªôt 3).
SQL
UPDATE chess_boards
SET board_state [2][3] = '.',
board_state [3][3] = 'p'
WHERE board_id = 1;
5. To√°n t·ª≠ @> (Contains) v√† <@ (Contained By) v·ªõi M·∫£ng 2 Chi·ªÅu (√çt Ph·ªï Bi·∫øn h∆°n):
Vi·ªác s·ª≠ d·ª•ng @> v√† <@ tr·ª±c ti·∫øp tr√™n m·∫£ng 2 chi·ªÅu ƒë·ªÉ so s√°nh "ch·ª©a" v√† "b·ªã ch·ª©a" c√≥ th·ªÉ ph·ª©c t·∫°p v√† √≠t tr·ª±c quan h∆°n so v·ªõi m·∫£ng m·ªôt chi·ªÅu. PostgreSQL s·∫Ω so s√°nh xem m·ªôt m·∫£ng 2 chi·ªÅu c√≥ ch·ª©a m·ªôt m·∫£ng con 2 chi·ªÅu kh√°c hay kh√¥ng.
V√≠ d·ª• (c√≥ th·ªÉ kh√¥ng mang nhi·ªÅu √Ω nghƒ©a trong ng·ªØ c·∫£nh b√†n c·ªù):
Gi·∫£ s·ª≠ ch√∫ng ta ch√®n th√™m m·ªôt tr·∫°ng th√°i b·∫£ng c·ªù c√≥ m·ªôt ph·∫ßn gi·ªëng v·ªõi tr·∫°ng th√°i ban ƒë·∫ßu.
SQL
INSERT INTO chess_boards (description, board_state)
VALUES (
'Partial board state',
'{{'r','n','b'},
{'p','p','p'}}'
);
Ki·ªÉm tra xem tr·∫°ng th√°i ban ƒë·∫ßu c√≥ ch·ª©a tr·∫°ng th√°i "Partial board state" (ƒëi·ªÅu n√†y s·∫Ω tr·∫£ v·ªÅ false v√¨ k√≠ch th∆∞·ªõc kh√°c nhau):
SQL
SELECT b1.description, b2.description
FROM chess_boards b1, chess_boards b2
WHERE b1.board_id = 1 AND b2.board_id = 2
AND b1.board_state @> b2.board_state;
ƒê·ªÉ so s√°nh c√°c ph·∫ßn t·ª≠ c·ª• th·ªÉ, b·∫°n c√≥ th·ªÉ c·∫ßn truy c·∫≠p ch√∫ng b·∫±ng ch·ªâ m·ª•c.
6. To√°n t·ª≠ = (Equal) cho M·∫£ng 2 Chi·ªÅu:
Ch√®n m·ªôt b·∫£n sao c·ªßa tr·∫°ng th√°i ban ƒë·∫ßu.
SQL
INSERT INTO chess_boards (description, board_state)
SELECT 'Copy of initial state', board_state
FROM chess_boards
WHERE board_id = 1;
So s√°nh hai tr·∫°ng th√°i b·∫£ng c·ªù xem ch√∫ng c√≥ gi·ªëng nhau kh√¥ng.
SQL
SELECT b1.description, b2.description
FROM chess_boards b1, chess_boards b2
WHERE b1.board_id = 1 AND b2.board_id = 3
AND b1.board_state = b2.board_state;
7. To√°n t·ª≠ && (Overlap) v·ªõi M·∫£ng 2 Chi·ªÅu (C≈©ng √çt Ph·ªï Bi·∫øn):
To√°n t·ª≠ && ki·ªÉm tra xem hai m·∫£ng c√≥ b·∫•t k·ª≥ ph·∫ßn t·ª≠ chung n√†o kh√¥ng. V·ªõi m·∫£ng 2 chi·ªÅu, ƒëi·ªÅu n√†y c√≥ nghƒ©a l√† ch√∫ng c√≥ √≠t nh·∫•t m·ªôt c·∫∑p ch·ªâ m·ª•c (i, j) m√† gi√° tr·ªã t·∫°i ƒë√≥ b·∫±ng nhau.
V√≠ d·ª• (c√≥ th·ªÉ kh√¥ng th·ª±c t·∫ø cho b√†n c·ªù):
SQL
INSERT INTO chess_boards (description, board_state)
VALUES (
'Overlapping state',
'{{'x','n','b','q','k','b','n','y'},
{'p','z','p','p','p','p','p','w'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'.','.','.','.','.','.','.','.'},
{'P','P','P','P','P','P','P','P'},
{'R','N','B','Q','K','B','N','R'}}'
);
SQL
SELECT b1.description, b3.description
FROM chess_boards b1, chess_boards b3
WHERE b1.board_id = 1 AND b3.board_id = 4
AND b1.board_state && b3.board_state; -- S·∫Ω tr·∫£ v·ªÅ true v√¨ c√≥ nhi·ªÅu ph·∫ßn t·ª≠ tr√πng nhau
8. H√†m M·∫£ng N√¢ng Cao v·ªõi M·∫£ng 2 Chi·ªÅu:
array_length(board_state, 1): L·∫•y s·ªë h√†ng (8 trong tr∆∞·ªùng h·ª£p n√†y).
array_length(board_state, 2): L·∫•y s·ªë c·ªôt (8 trong tr∆∞·ªùng h·ª£p n√†y).
array_dims(board_state): Tr·∫£ v·ªÅ k√≠ch th∆∞·ªõc m·∫£ng (v√≠ d·ª•: "[2:9][1:8]" n·∫øu b·∫°n ƒë√£ ch√®n th√™m d·ªØ li·ªáu).
unnest(board_state): S·∫Ω tr·∫£i ph·∫≥ng m·∫£ng 2 chi·ªÅu th√†nh m·ªôt t·∫≠p h·ª£p c√°c h√†ng, m·ªói h√†ng ch·ª©a m·ªôt ph·∫ßn t·ª≠. B·∫°n c√≥ th·ªÉ c·∫ßn s·ª≠ d·ª•ng WITH ORDINALITY ƒë·ªÉ theo d√µi v·ªã tr√≠.
SQL
SELECT (unnest(board_state)).*, row_num, col_num
FROM chess_boards,
LATERAL unnest(board_state) WITH ORDINALITY AS b(piece, row_num)
LATERAL (SELECT generate_series(1, array_length(board_state, 2))) AS cols(col_num)
WHERE board_id = 1

- 14 INSERT INTO books (title, attr)
VALUES (
'The Hedge Knight',
'"paperback" => "350",
"publisher" => "Tor Books",
"language" => "English",
"ISBN-13" => "978-0765359271",
"weight" => "5.3 ounces"'
)
RETURNING id, attr -> 'publisher' AS publisher;
INSERT INTO books (title, attr)
VALUES
(
'The Sworn Sword',
'"paperback" => "208",
"publisher" => "Tor Books",
"language" => "English",
"ISBN-13" => "978-0765359288",
"weight" => "3.2 ounces"'
),
(
'The Mystery Knight',
'"paperback" => "384",
"publisher" => "Tor Books",
"language" => "English",
"ISBN-13" => "978-0765359295",
"weight" => "6.1 ounces"'
)
RETURNING *;
M·ªánh ƒë·ªÅ RETURNING trong Postgres cho ph√©p b·∫°n nh·∫≠n l·∫°i gi√° tr·ªã c·ªßa c√°c c·ªôt t·ª´ c√°c h√†ng v·ª´a b·ªã t√°c ƒë·ªông b·ªüi c√°c c√¢u l·ªánh DML (Data Manipulation Language) nh∆∞ INSERT, UPDATE, ho·∫∑c DELETE.
N√≥ ho·∫°t ƒë·ªông gi·ªëng nh∆∞ m·ªôt c√¢u l·ªánh SELECT ƒë∆∞·ª£c th·ª±c hi·ªán ƒë·ªìng th·ªùi tr√™n c√°c h√†ng v·ª´a m·ªõi ƒë∆∞·ª£c th√™m, s·ª≠a ƒë·ªïi ho·∫∑c x√≥a.

- 15 CREATE EXTENSION pgcrypto;
CREATE TABLE usersTest2 (
id SERIAL PRIMARY KEY,
username VARCHAR(50) UNIQUE NOT NULL,
password_hash TEXT NOT NULL,
email VARCHAR(100) UNIQUE,
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO usersTest2 (username, password_hash, email)
VALUES ('john.doe', crypt('secure123', gen_salt('bf')), 'john.doe@example.com');
SELECT * FROM usersTest2
SELECT username
FROM usersTest2
WHERE username = 'john.doe'
AND password_hash = crypt('secure123', password_hash);
L·ªánh insert v√†o b·∫£ng usersTest2 v·ªõi m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c m√£ h√≥a v√† select ra t√™n d·ª±a v√†o chu·ªói
SELECT digest('This is some sensitive data', 'sha256');
SELECT digest('test@example.com', 'md5');
SELECT encode(digest('test@example.com', 'md5'), 'hex');
SELECT encode(digest('This is some sensitive data', 'sha256'), 'hex');

- 16 Kh√¥ng n√™n l√†m trong PostgreSQL
Tuy·ªát ƒë·ªëi! D∆∞·ªõi ƒë√¢y l√† b·∫£n t√≥m t·∫Øt ƒë·∫ßy ƒë·ªß v√† chi ti·∫øt c·ªßa c√°c √Ω trong trang Wiki "Don't Do This" v·ªÅ nh·ªØng ƒëi·ªÅu n√™n tr√°nh khi l√†m vi·ªác v·ªõi PostgreSQL, ƒë√£ ƒë∆∞·ª£c d·ªãch sang ti·∫øng Vi·ªát:

M√£ h√≥a C∆° s·ªü D·ªØ li·ªáu (Database Encoding)

Kh√¥ng d√πng SQL_ASCII:

SQL_ASCII coi d·ªØ li·ªáu nh∆∞ m·ªôt chu·ªói byte m√† kh√¥ng th·ª±c hi·ªán b·∫•t k·ª≥ chuy·ªÉn ƒë·ªïi m√£ h√≥a n√†o. ƒêi·ªÅu n√†y d·∫´n ƒë·∫øn t√¨nh tr·∫°ng c∆° s·ªü d·ªØ li·ªáu ch·ª©a h·ªón h·ª£p nhi·ªÅu m√£ h√≥a kh√°c nhau, g√¢y kh√≥ khƒÉn cho vi·ªác kh√¥i ph·ª•c k√Ω t·ª± g·ªëc m·ªôt c√°ch ƒë√°ng tin c·∫≠y.

Khi n√†o n√™n d√πng? Ch·ªâ khi d·ªØ li·ªáu ƒë·∫ßu v√†o ƒë√£ l√† m·ªôt m·ªõ h·ªón ƒë·ªôn c√°c m√£ h√≥a kh√¥ng r√µ r√†ng (v√≠ d·ª•: log k√™nh IRC, email kh√¥ng tu√¢n th·ªß MIME) v√† nh∆∞ m·ªôt bi·ªán ph√°p cu·ªëi c√πng. Tuy nhi√™n, h√£y c√¢n nh·∫Øc s·ª≠ d·ª•ng bytea tr∆∞·ªõc ho·∫∑c th·ª≠ t·ª± ƒë·ªông ph√°t hi·ªán UTF8 v√† gi·∫£ ƒë·ªãnh c√°c d·ªØ li·ªáu kh√¥ng ph·∫£i UTF8 thu·ªôc m·ªôt m√£ h√≥a c·ª• th·ªÉ (v√≠ d·ª•: WIN1252).

S·ª≠ d·ª•ng C√¥ng c·ª• (Tool Usage)

Kh√¥ng d√πng psql -W ho·∫∑c --password:

C√°c t√πy ch·ªçn n√†y khi·∫øn psql lu√¥n h·ªèi m·∫≠t kh·∫©u tr∆∞·ªõc khi k·∫øt n·ªëi, ngay c·∫£ khi m√°y ch·ªß kh√¥ng y√™u c·∫ßu.

ƒêi·ªÅu n√†y kh√¥ng c·∫ßn thi·∫øt v√¨ psql s·∫Ω t·ª± ƒë·ªông h·ªèi m·∫≠t kh·∫©u n·∫øu m√°y ch·ªß y√™u c·∫ßu. Vi·ªác s·ª≠ d·ª•ng -W c√≥ th·ªÉ g√¢y nh·∫ßm l·∫´n khi thi·∫øt l·∫≠p quy·ªÅn v√† c√≥ th·ªÉ khi·∫øn b·∫°n nghƒ© r·∫±ng c·∫ßn m·∫≠t kh·∫©u khi th·ª±c t·∫ø kh√¥ng ph·∫£i. B·∫°n c≈©ng c√≥ th·ªÉ nghƒ© m√¨nh ƒë√£ nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u khi th·ª±c t·∫ø kh√¥ng ph·∫£i v·∫≠y, g√¢y ra v·∫•n ƒë·ªÅ khi k·∫øt n·ªëi t·ª´ c√°c client kh√°c.

Khi n√†o n√™n d√πng? G·∫ßn nh∆∞ kh√¥ng bao gi·ªù. N√≥ c√≥ th·ªÉ gi√∫p ti·∫øt ki·ªám m·ªôt l∆∞·ª£t giao ti·∫øp v·ªõi m√°y ch·ªß, nh∆∞ng l·ª£i √≠ch n√†y kh√¥ng ƒë√°ng so v·ªõi nh·ªØng r·ªßi ro v√† nh·∫ßm l·∫´n c√≥ th·ªÉ x·∫£y ra.

C·∫•u tr√∫c SQL (SQL Constructs)

Kh√¥ng d√πng Rules:

Rules (lu·∫≠t) r·∫•t m·∫°nh m·∫Ω nh∆∞ng ho·∫°t ƒë·ªông kh√¥ng nh∆∞ v·∫ª ngo√†i c·ªßa ch√∫ng. Ch√∫ng kh√¥ng ph·∫£i l√† logic ƒëi·ªÅu ki·ªán m√† th·ª±c t·∫ø l√† vi·∫øt l·∫°i truy v·∫•n ƒë·ªÉ s·ª≠a ƒë·ªïi ho·∫∑c th√™m c√°c truy v·∫•n kh√°c.

H·∫ßu h·∫øt c√°c rule ph·ª©c t·∫°p ƒë·ªÅu kh√¥ng ch√≠nh x√°c.

Khi n√†o n√™n d√πng? Kh√¥ng bao gi·ªù. M·∫∑c d√π b·ªô vi·∫øt l·∫°i truy v·∫•n l√† m·ªôt chi ti·∫øt tri·ªÉn khai c·ªßa Views, kh√¥ng c√≥ l√Ω do g√¨ ƒë·ªÉ can thi·ªáp tr·ª±c ti·∫øp v√†o n√≥ th√¥ng qua Rules. H√£y s·ª≠ d·ª•ng Triggers (b·ªô k√≠ch ho·∫°t) thay th·∫ø n·∫øu b·∫°n nghƒ© m√¨nh c·∫ßn Rules.

Kh√¥ng d√πng Table Inheritance (K·∫ø th·ª´a B·∫£ng):

Table Inheritance l√† m·ªôt ph·∫ßn c·ªßa xu h∆∞·ªõng li√™n k·∫øt ch·∫∑t ch·∫Ω c∆° s·ªü d·ªØ li·ªáu v·ªõi m√£ h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng, nh∆∞ng h√≥a ra vi·ªác li√™n k·∫øt qu√° ch·∫∑t ch·∫Ω kh√¥ng mang l·∫°i k·∫øt qu·∫£ mong mu·ªën.

Khi n√†o n√™n d√πng? G·∫ßn nh∆∞ kh√¥ng bao gi·ªù. V·ªõi vi·ªác ph√¢n v√πng b·∫£ng (table partitioning) ƒë√£ ƒë∆∞·ª£c h·ªó tr·ª£ tr·ª±c ti·∫øp, tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn nh·∫•t c·ªßa Table Inheritance ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng m·ªôt t√≠nh nƒÉng g·ªëc m·∫°nh m·∫Ω h∆°n. M·ªôt ngo·∫°i l·ªá r·∫•t hi·∫øm hoi c√≥ th·ªÉ l√† khi s·ª≠ d·ª•ng extension temporal_tables ƒë·ªÉ theo d√µi l·ªãch s·ª≠ phi√™n b·∫£n c·ªßa c√°c h√†ng khi kh√¥ng c√≥ h·ªó tr·ª£ SQL 2011. Ngay c·∫£ trong tr∆∞·ªùng h·ª£p n√†y, b·∫°n c≈©ng n√™n c·∫©n tr·ªçng v·ªõi nh·ªØng h·∫°n ch·∫ø khi l√†m vi·ªác v·ªõi b·∫£ng cha. H√£y s·ª≠ d·ª•ng Foreign Keys (kh√≥a ngo·∫°i) thay th·∫ø n·∫øu b·∫°n nghƒ© m√¨nh c·∫ßn Table Inheritance.

Kh√¥ng d√πng NOT IN (ho·∫∑c b·∫•t k·ª≥ t·ªï h·ª£p NOT v√† IN n√†o):

L√Ω do 1: H√†nh vi b·∫•t ng·ªù v·ªõi NULL:

SELECT * FROM foo WHERE col NOT IN (1, NULL); lu√¥n tr·∫£ v·ªÅ 0 h√†ng.

SELECT * FROM foo WHERE foo.col NOT IN (SELECT bar.x FROM bar); tr·∫£ v·ªÅ 0 h√†ng n·∫øu b·∫•t k·ª≥ gi√° tr·ªã n√†o c·ªßa bar.x l√† NULL.

ƒêi·ªÅu n√†y x·∫£y ra v√¨ col IN (1, NULL) tr·∫£ v·ªÅ TRUE n·∫øu col=1 v√† NULL trong c√°c tr∆∞·ªùng h·ª£p kh√°c (kh√¥ng bao gi·ªù tr·∫£ v·ªÅ FALSE). NOT (TRUE) l√† FALSE, nh∆∞ng NOT (NULL) v·∫´n l√† NULL, do ƒë√≥ NOT (col IN (1, NULL)) kh√¥ng bao gi·ªù c√≥ th·ªÉ tr·∫£ v·ªÅ TRUE.

L√Ω do 2: Hi·ªáu su·∫•t k√©m: Do h√†nh vi v·ªõi NULL, NOT IN (SELECT ...) th∆∞·ªùng kh√¥ng ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a t·ªët. Planner kh√¥ng th·ªÉ chuy·ªÉn n√≥ th√†nh anti-join, d·∫´n ƒë·∫øn vi·ªác s·ª≠ d·ª•ng Hashed Subplan (nhanh cho t·∫≠p k·∫øt qu·∫£ nh·ªè) ho·∫∑c Plain Subplan (r·∫•t ch·∫≠m, O(N¬≤)). Hi·ªáu su·∫•t c√≥ th·ªÉ t·ªët trong th·ª≠ nghi·ªám nh·ªè nh∆∞ng gi·∫£m ƒë√°ng k·ªÉ khi v∆∞·ª£t qua m·ªôt ng∆∞·ª°ng k√≠ch th∆∞·ªõc nh·∫•t ƒë·ªãnh.

Gi·∫£i ph√°p thay th·∫ø: Trong h·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p, h√†nh vi NULL c·ªßa NOT IN (SELECT ...) kh√¥ng mong mu·ªën. H√£y vi·∫øt l·∫°i truy v·∫•n b·∫±ng NOT EXISTS (SELECT ...):
SELECT * FROM foo WHERE NOT EXISTS (SELECT FROM bar WHERE foo.col = bar.x);

Khi n√†o n√™n d√πng? NOT IN (list, of, values, ...) th∆∞·ªùng an to√†n tr·ª´ khi danh s√°ch c√≥ th·ªÉ ch·ª©a NULL (th√¥ng qua tham s·ªë ho·∫∑c c√°ch kh√°c). ƒê√¥i khi n√≥ t·ª± nhi√™n v√† h·ª£p l√Ω khi lo·∫°i tr·ª´ c√°c gi√° tr·ªã h·∫±ng c·ª• th·ªÉ kh·ªèi k·∫øt qu·∫£ truy v·∫•n.

Kh√¥ng d√πng t√™n b·∫£ng ho·∫∑c c·ªôt vi·∫øt hoa (Upper Case):

H√£y d√πng names_like_this thay v√¨ NamesLikeThis.

PostgreSQL t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi t·∫•t c·∫£ t√™n (b·∫£ng, c·ªôt, h√†m, v.v.) th√†nh ch·ªØ th∆∞·ªùng tr·ª´ khi ch√∫ng ƒë∆∞·ª£c ƒë·∫∑t trong d·∫•u ngo·∫∑c k√©p.

CREATE TABLE Foo() s·∫Ω t·∫°o b·∫£ng t√™n foo, trong khi CREATE TABLE "Bar"() s·∫Ω t·∫°o b·∫£ng t√™n Bar.

C√°c l·ªánh SELECT * FROM Foo, SELECT * FROM foo, SELECT * FROM "Bar" s·∫Ω ho·∫°t ƒë·ªông.

C√°c l·ªánh SELECT * FROM "Foo", SELECT * FROM Bar, SELECT * FROM bar s·∫Ω th·∫•t b·∫°i v·ªõi l·ªói "no such table".

Vi·ªác s·ª≠ d·ª•ng ch·ªØ hoa bu·ªôc b·∫°n ph·∫£i lu√¥n ƒë·∫∑t t√™n trong d·∫•u ngo·∫∑c k√©p ho·∫∑c kh√¥ng bao gi·ªù, g√¢y kh√≥ ch·ªãu khi thao t√°c th·ªß c√¥ng v√† ƒë·∫∑c bi·ªát khi s·ª≠ d·ª•ng c√°c c√¥ng c·ª• kh√°c nhau c√≥ c√°ch x·ª≠ l√Ω d·∫•u ngo·∫∑c k√©p kh√°c nhau.

L·ªùi khuy√™n: H√£y s·ª≠ d·ª•ng a-z, 0-9 v√† d·∫•u g·∫°ch d∆∞·ªõi cho t√™n ƒë·ªÉ kh√¥ng bao gi·ªù ph·∫£i lo l·∫Øng v·ªÅ vi·ªác ƒë·∫∑t d·∫•u ngo·∫∑c k√©p.

Khi n√†o n√™n d√πng? N·∫øu vi·ªác hi·ªÉn th·ªã t√™n "ƒë·∫πp" trong b√°o c√°o l√† quan tr·ªçng, b·∫°n c√≥ th·ªÉ c√¢n nh·∫Øc. Tuy nhi√™n, b·∫°n c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng b√≠ danh c·ªôt (column aliases) ƒë·ªÉ c√≥ t√™n ch·ªØ th∆∞·ªùng trong b·∫£ng v√† v·∫´n hi·ªÉn th·ªã t√™n ƒë·∫πp trong k·∫øt qu·∫£ truy v·∫•n (v√≠ d·ª•: SELECT character_name AS "Character Name" FROM foo;).

Kh√¥ng d√πng BETWEEN (ƒë·∫∑c bi·ªát v·ªõi timestamps):

BETWEEN s·ª≠ d·ª•ng so s√°nh kho·∫£ng ƒë√≥ng: c·∫£ gi√° tr·ªã ·ªü hai ƒë·∫ßu c·ªßa kho·∫£ng ƒë·ªÅu ƒë∆∞·ª£c bao g·ªìm trong k·∫øt qu·∫£.

ƒê√¢y l√† v·∫•n ƒë·ªÅ ƒë·∫∑c bi·ªát v·ªõi c√°c truy v·∫•n d·∫°ng:
SELECT * FROM blah WHERE timestampcol BETWEEN '2018-06-01' AND '2018-06-08';
Truy v·∫•n n√†y s·∫Ω bao g·ªìm c√°c k·∫øt qu·∫£ c√≥ timestamp ch√≠nh x√°c l√† 2018-06-08 00:00:00.000000, nh∆∞ng kh√¥ng bao g·ªìm c√°c timestamp sau ƒë√≥ trong c√πng ng√†y. ƒêi·ªÅu n√†y c√≥ th·ªÉ d·∫´n ƒë·∫øn vi·ªác ƒë·∫øm tr√πng c√°c b·∫£n ghi x·∫£y ra ƒë√∫ng v√†o n·ª≠a ƒë√™m.

Thay v√†o ƒë√≥, h√£y d√πng:
SELECT * FROM blah WHERE timestampcol >= '2018-06-01' AND timestampcol < '2018-06-09'; (L∆∞u √Ω thay ƒë·ªïi ng√†y k·∫øt th√∫c) ho·∫∑c AND timestampcol < '2018-06-08'::date + '1 day'::interval

Khi n√†o n√™n d√πng? BETWEEN an to√†n cho c√°c ƒë·∫°i l∆∞·ª£ng r·ªùi r·∫°c nh∆∞ s·ªë nguy√™n ho·∫∑c ng√†y th√°ng, mi·ªÖn l√† b·∫°n nh·ªõ r·∫±ng c·∫£ hai ƒë·∫ßu c·ªßa kho·∫£ng ƒë·ªÅu ƒë∆∞·ª£c bao g·ªìm. Tuy nhi√™n, n√™n tr√°nh th√≥i quen s·ª≠ d·ª•ng n√≥, ƒë·∫∑c bi·ªát v·ªõi timestamps.

L∆∞u tr·ªØ Ng√†y/Gi·ªù (Date/Time Storage)

Kh√¥ng d√πng timestamp (without time zone):

H√£y d√πng timestamptz (c√≤n g·ªçi l√† timestamp with time zone) ƒë·ªÉ l∆∞u tr·ªØ timestamps.

timestamptz ghi l·∫°i m·ªôt kho·∫£nh kh·∫Øc duy nh·∫•t trong th·ªùi gian. N√≥ kh√¥ng l∆∞u tr·ªØ m√∫i gi·ªù, m√† ch·ªâ l√† m·ªôt ƒëi·ªÉm th·ªùi gian ƒë∆∞·ª£c m√¥ t·∫£ b·∫±ng s·ªë micro gi√¢y k·ªÉ t·ª´ ng√†y 1 th√°ng 1 nƒÉm 2000 UTC. B·∫°n c√≥ th·ªÉ ch√®n gi√° tr·ªã ·ªü b·∫•t k·ª≥ m√∫i gi·ªù n√†o v√† n√≥ s·∫Ω l∆∞u tr·ªØ ƒëi·ªÉm th·ªùi gian t∆∞∆°ng ·ª©ng. Theo m·∫∑c ƒë·ªãnh, n√≥ hi·ªÉn th·ªã th·ªùi gian theo m√∫i gi·ªù hi·ªán t·∫°i c·ªßa b·∫°n, nh∆∞ng b·∫°n c√≥ th·ªÉ d√πng AT TIME ZONE ƒë·ªÉ hi·ªÉn th·ªã ·ªü c√°c m√∫i gi·ªù kh√°c.

V√¨ n√≥ l∆∞u tr·ªØ m·ªôt ƒëi·ªÉm th·ªùi gian, n√≥ s·∫Ω x·ª≠ l√Ω ƒë√∫ng c√°c ph√©p to√°n li√™n quan ƒë·∫øn timestamps ƒë∆∞·ª£c nh·∫≠p ·ªü c√°c m√∫i gi·ªù kh√°c nhau, bao g·ªìm c·∫£ s·ª± kh√°c bi·ªát do thay ƒë·ªïi gi·ªù m√πa h√® (daylight saving time).

timestamp (without time zone) ch·ªâ l∆∞u tr·ªØ ng√†y v√† gi·ªù b·∫°n cung c·∫•p m√† kh√¥ng c√≥ th√¥ng tin v·ªÅ m√∫i gi·ªù. N√≥ gi·ªëng nh∆∞ m·ªôt b·ª©c ·∫£nh ch·ª•p ƒë·ªìng h·ªì v√† l·ªãch h∆°n l√† m·ªôt ƒëi·ªÉm th·ªùi gian th·ª±c t·∫ø. Do ƒë√≥, c√°c ph√©p to√°n gi·ªØa c√°c timestamps t·ª´ c√°c v·ªã tr√≠ kh√°c nhau ho·∫∑c gi·ªØa c√°c timestamps trong m√πa h√® v√† m√πa ƒë√¥ng c√≥ th·ªÉ cho k·∫øt qu·∫£ sai.

Khi n√†o n√™n d√πng? N·∫øu b·∫°n ƒëang x·ª≠ l√Ω timestamps m·ªôt c√°ch tr·ª´u t∆∞·ª£ng ho·∫∑c ch·ªâ l∆∞u v√† truy xu·∫•t ch√∫ng t·ª´ ·ª©ng d·ª•ng m√† kh√¥ng th·ª±c hi·ªán c√°c ph√©p to√°n ph·ª©c t·∫°p, th√¨ timestamp c√≥ th·ªÉ ph√π h·ª£p.

Kh√¥ng d√πng timestamp (without time zone) ƒë·ªÉ l∆∞u tr·ªØ th·ªùi gian UTC:

Vi·ªác l∆∞u tr·ªØ gi√° tr·ªã UTC trong c·ªôt timestamp without time zone l√† m·ªôt th√≥i quen th∆∞·ªùng th·∫•y t·ª´ c√°c c∆° s·ªü d·ªØ li·ªáu kh√°c thi·∫øu h·ªó tr·ª£ m√∫i gi·ªù t·ªët.

H√£y d√πng timestamp with time zone thay th·∫ø.

T·∫°i sao kh√¥ng? V√¨ c∆° s·ªü d·ªØ li·ªáu kh√¥ng c√≥ c√°ch n√†o bi·∫øt r·∫±ng UTC l√† m√∫i gi·ªù d·ª± ƒë·ªãnh cho c√°c gi√° tr·ªã trong c·ªôt. ƒêi·ªÅu n√†y l√†m ph·ª©c t·∫°p nhi·ªÅu ph√©p t√≠nh th·ªùi gian h·ªØu √≠ch. V√≠ d·ª•, "n·ª≠a ƒë√™m tr∆∞·ªõc ƒë√≥ theo m√∫i gi·ªù c·ªßa ng∆∞·ªùi d√πng u.timezone" tr·ªü th√†nh m·ªôt bi·ªÉu th·ª©c r·∫•t d√†i v√† kh√≥ hi·ªÉu.

Khi n√†o n√™n d√πng? N·∫øu kh·∫£ nƒÉng t∆∞∆°ng th√≠ch v·ªõi c√°c c∆° s·ªü d·ªØ li·ªáu kh√¥ng h·ªó tr·ª£ m√∫i gi·ªù quan tr·ªçng h∆°n t·∫•t c·∫£ c√°c c√¢n nh·∫Øc kh√°c.

Kh√¥ng d√πng timetz:

B·∫°n c√≥ l·∫Ω mu·ªën d√πng timestamptz thay th·∫ø.

Ngay c·∫£ t√†i li·ªáu h∆∞·ªõng d·∫´n c≈©ng n√≥i r·∫±ng n√≥ ch·ªâ ƒë∆∞·ª£c tri·ªÉn khai ƒë·ªÉ tu√¢n th·ªß ti√™u chu·∫©n SQL.

Ki·ªÉu time with time zone ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong ti√™u chu·∫©n SQL, nh∆∞ng ƒë·ªãnh nghƒ©a c·ªßa n√≥ c√≥ nh·ªØng thu·ªôc t√≠nh d·∫´n ƒë·∫øn t√≠nh h·ªØu d·ª•ng ƒë√°ng ng·ªù. Trong h·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p, s·ª± k·∫øt h·ª£p c·ªßa date, time, timestamp without time zone, v√† timestamp with time zone s·∫Ω cung c·∫•p ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng ng√†y/gi·ªù c·∫ßn thi·∫øt cho b·∫•t k·ª≥ ·ª©ng d·ª•ng n√†o.

Khi n√†o n√™n d√πng? Kh√¥ng bao gi·ªù.

Kh√¥ng d√πng CURRENT_TIME:

H√£y d√πng m·ªôt trong c√°c h√†m sau cho ph√π h·ª£p:

CURRENT_TIMESTAMP ho·∫∑c now() n·∫øu b·∫°n mu·ªën timestamp c√≥ m√∫i gi·ªù.

LOCALTIMESTAMP n·∫øu b·∫°n mu·ªën timestamp kh√¥ng c√≥ m√∫i gi·ªù.

CURRENT_DATE n·∫øu b·∫°n mu·ªën ng√†y.

LOCALTIME n·∫øu b·∫°n mu·ªën th·ªùi gian.

T·∫°i sao kh√¥ng? V√¨ CURRENT_TIME tr·∫£ v·ªÅ gi√° tr·ªã ki·ªÉu timetz, nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p ·ªü tr√™n.

Khi n√†o n√™n d√πng? Kh√¥ng bao gi·ªù.

Kh√¥ng d√πng timestamp(0) ho·∫∑c timestamptz(0):

ƒê·ª´ng ch·ªâ ƒë·ªãnh ƒë·ªô ch√≠nh x√°c, ƒë·∫∑c bi·ªát l√† 0, cho c√°c c·ªôt timestamp ho·∫∑c khi √©p ki·ªÉu sang timestamp.

H√£y d√πng date_trunc('second', blah) thay th·∫ø.

T·∫°i sao kh√¥ng? V√¨ n√≥ l√†m tr√≤n ph·∫ßn th·∫≠p ph√¢n thay v√¨ c·∫Øt b·ªõt nh∆∞ m·ªçi ng∆∞·ªùi mong ƒë·ª£i. ƒêi·ªÅu n√†y c√≥ th·ªÉ g√¢y ra c√°c v·∫•n ƒë·ªÅ kh√¥ng mong mu·ªën. V√≠ d·ª•, khi b·∫°n l∆∞u now() v√†o m·ªôt c·ªôt nh∆∞ v·∫≠y, b·∫°n c√≥ th·ªÉ ƒëang l∆∞u m·ªôt gi√° tr·ªã n·ª≠a gi√¢y trong t∆∞∆°ng lai.

Khi n√†o n√™n d√πng? Kh√¥ng bao gi·ªù.

Kh√¥ng d√πng +/-HH:mm l√†m t√™n M√∫i gi·ªù d·∫°ng text:

PostgreSQL kh√¥ng ch·∫•p nh·∫≠n c√°c offset m√∫i gi·ªù c·ªë ƒë·ªãnh thay cho t√™n ho·∫∑c ch·ªØ vi·∫øt t·∫Øt m√∫i gi·ªù ISO. N·∫øu b·∫°n ch·ªâ ƒë·ªãnh m·ªôt offset nh∆∞ v·∫≠y, n√≥ s·∫Ω ƒë∆∞·ª£c hi·ªÉu l√† m·ªôt ƒë·∫∑c t·∫£ m√∫i gi·ªù POSIX t√πy ch·ªânh v·ªõi thu·ªôc t√≠nh kh√¥ng may l√† gi√° tr·ªã d∆∞∆°ng d·ªãch v·ªÅ ph√≠a t√¢y trong khi gi√° tr·ªã √¢m d·ªãch v·ªÅ ph√≠a ƒë√¥ng (quy ∆∞·ªõc ISO l√† d·ªãch v·ªÅ ph√≠a ƒë√¥ng ƒë∆∞·ª£c k√Ω hi·ªáu l√† √¢m).

L∆∞u √Ω r·∫±ng n·∫øu b·∫°n cung c·∫•p m·ªôt gi√° tr·ªã ki·ªÉu interval, quy ∆∞·ªõc ISO s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng. V√¨ v·∫≠y, n·∫øu b·∫°n th·ª±c s·ª± mu·ªën ch·ªâ ƒë·ªãnh m·ªôt offset c·ªë ƒë·ªãnh, b·∫°n c√≥ th·ªÉ vi·∫øt: AT TIME ZONE INTERVAL '04:00'.

Khi n√†o n√™n d√πng? M·ªôt literal timestamptz d·∫°ng chu·ªói theo ƒë·ªãnh d·∫°ng ISO c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt b·∫±ng offset c√≥ d·∫•u v√† chi·ªÅu c·ªßa d·∫•u s·∫Ω ƒë∆∞·ª£c gi·∫£i th√≠ch theo quy ∆∞·ªõc ISO. V√≠ d·ª•: SELECT '2024-01-31 17:16:25+04'::timestamptz; cho ra k·∫øt qu·∫£ l√† 1 gi·ªù chi·ªÅu UTC.

L∆∞u tr·ªØ VƒÉn b·∫£n (Text Storage)

Kh√¥ng d√πng char(n):

B·∫°n c√≥ l·∫Ω mu·ªën d√πng text.

B·∫•t k·ª≥ chu·ªói n√†o b·∫°n ch√®n v√†o tr∆∞·ªùng char(n) s·∫Ω ƒë∆∞·ª£c ƒë·ªám b·∫±ng kho·∫£ng tr·∫Øng cho ƒë·∫øn ƒë·ªô d√†i ƒë√£ khai b√°o. ƒêi·ªÅu n√†y c√≥ l·∫Ω kh√¥ng ph·∫£i l√† ƒëi·ªÅu b·∫°n th·ª±c s·ª± mu·ªën.

T√†i li·ªáu h∆∞·ªõng d·∫´n n√≥i r·∫±ng c√°c gi√° tr·ªã ki·ªÉu character ƒë∆∞·ª£c ƒë·ªám v·∫≠t l√Ω b·∫±ng kho·∫£ng tr·∫Øng ƒë·∫øn ƒë·ªô d√†i n v√† ƒë∆∞·ª£c l∆∞u tr·ªØ v√† hi·ªÉn th·ªã theo c√°ch ƒë√≥. Tuy nhi√™n, c√°c kho·∫£ng tr·∫Øng ·ªü cu·ªëi ƒë∆∞·ª£c coi l√† kh√¥ng quan tr·ªçng v·ªÅ m·∫∑t ng·ªØ nghƒ©a v√† b·ªã b·ªè qua khi so s√°nh hai gi√° tr·ªã ki·ªÉu character. Trong c√°c ƒë·ªëi chi·∫øu m√† kho·∫£ng tr·∫Øng c√≥ √Ω nghƒ©a, h√†nh vi n√†y c√≥ th·ªÉ t·∫°o ra k·∫øt qu·∫£ b·∫•t ng·ªù. C√°c kho·∫£ng tr·∫Øng ·ªü cu·ªëi s·∫Ω b·ªã lo·∫°i b·ªè khi chuy·ªÉn ƒë·ªïi gi√° tr·ªã character sang m·ªôt trong c√°c ki·ªÉu chu·ªói kh√°c. L∆∞u √Ω r·∫±ng c√°c kho·∫£ng tr·∫Øng ·ªü cu·ªëi c√≥ √Ω nghƒ©a v·ªÅ m·∫∑t ng·ªØ nghƒ©a trong c√°c gi√° tr·ªã character varying v√† text, v√† khi s·ª≠ d·ª•ng so kh·ªõp m·∫´u (LIKE v√† regular expressions). ƒêi·ªÅu n√†y ƒë·ªß ƒë·ªÉ b·∫°n tr√°nh xa n√≥.

Vi·ªác ƒë·ªám b·∫±ng kho·∫£ng tr·∫Øng g√¢y l√£ng ph√≠ dung l∆∞·ª£ng v√† kh√¥ng l√†m cho c√°c thao t√°c tr√™n n√≥ nhanh h∆°n; th·ª±c t·∫ø ng∆∞·ª£c l·∫°i, do c·∫ßn ph·∫£i lo·∫°i b·ªè kho·∫£ng tr·∫Øng trong nhi·ªÅu ng·ªØ c·∫£nh.

Quan tr·ªçng c·∫ßn l∆∞u √Ω r·∫±ng t·ª´ quan ƒëi·ªÉm l∆∞u tr·ªØ, char(n) kh√¥ng ph·∫£i l√† ki·ªÉu c√≥ ƒë·ªô d√†i c·ªë ƒë·ªãnh. S·ªë byte th·ª±c t·∫ø thay ƒë·ªïi v√¨ c√°c k√Ω t·ª± c√≥ th·ªÉ chi·∫øm nhi·ªÅu h∆°n m·ªôt byte, v√† c√°c gi√° tr·ªã ƒë∆∞·ª£c l∆∞u tr·ªØ do ƒë√≥ v·∫´n ƒë∆∞·ª£c coi l√† c√≥ ƒë·ªô d√†i thay ƒë·ªïi (m·∫∑c d√π vi·ªác ƒë·ªám kho·∫£ng tr·∫Øng ƒë∆∞·ª£c bao g·ªìm trong l∆∞u tr·ªØ).

Khi n√†o n√™n d√πng? Khi b·∫°n ƒëang chuy·ªÉn ƒë·ªïi ph·∫ßn m·ªÅm r·∫•t c≈© s·ª≠ d·ª•ng c√°c tr∆∞·ªùng c√≥ ƒë·ªô d√†i c·ªë ƒë·ªãnh. Ho·∫∑c khi b·∫°n ƒë·ªçc ƒëo·∫°n tr√≠ch t·ª´ t√†i li·ªáu h∆∞·ªõng d·∫´n ·ªü tr√™n v√† nghƒ© r·∫±ng "v√¢ng, ƒëi·ªÅu ƒë√≥ ho√†n to√†n h·ª£p l√Ω v√† ph√π h·ª£p v·ªõi y√™u c·∫ßu c·ªßa t√¥i" thay v√¨ ho·∫£ng s·ª£ v√† b·ªè ch·∫°y.

Kh√¥ng d√πng char(n) ngay c·∫£ cho c√°c ƒë·ªãnh danh c√≥ ƒë·ªô d√†i c·ªë ƒë·ªãnh:

ƒê√¥i khi m·ªçi ng∆∞·ªùi ph·∫£n ·ª©ng v·ªõi "kh√¥ng d√πng char(n)" b·∫±ng c√°ch n√≥i "nh∆∞ng c√°c gi√° tr·ªã c·ªßa t√¥i ph·∫£i lu√¥n c√≥ ch√≠nh x√°c N k√Ω t·ª±" (v√≠ d·ª•: m√£ qu·ªëc gia, hash, ho·∫∑c ƒë·ªãnh danh t·ª´ h·ªá th·ªëng kh√°c). Vi·ªác s·ª≠ d·ª•ng char(n) ngay c·∫£ trong nh·ªØng tr∆∞·ªùng h·ª£p n√†y v·∫´n l√† m·ªôt √Ω t∆∞·ªüng t·ªìi.

H√£y d√πng text, ho·∫∑c m·ªôt domain tr√™n text, v·ªõi CHECK(length(VALUE) = 3) ho·∫∑c CHECK(VALUE ~ '^[[:alpha:]]{3}$') ho·∫∑c t∆∞∆°ng t·ª±.

T·∫°i sao kh√¥ng? V√¨ char(n) kh√¥ng t·ª´ ch·ªëi c√°c gi√° tr·ªã qu√° ng·∫Øn, n√≥ ch·ªâ √¢m th·∫ßm ƒë·ªám ch√∫ng b·∫±ng kho·∫£ng tr·∫Øng. V√¨ v·∫≠y, kh√¥ng c√≥ l·ª£i √≠ch th·ª±c s·ª± n√†o so v·ªõi vi·ªác s·ª≠ d·ª•ng text v·ªõi m·ªôt r√†ng bu·ªôc ki·ªÉm tra ƒë·ªô d√†i ch√≠nh x√°c. Th√™m v√†o ƒë√≥, m·ªôt ki·ªÉm tra nh∆∞ v·∫≠y c≈©ng c√≥ th·ªÉ x√°c minh r·∫±ng gi√° tr·ªã ·ªü ƒë√∫ng ƒë·ªãnh d·∫°ng.

H√£y nh·ªõ r·∫±ng kh√¥ng c√≥ l·ª£i √≠ch hi·ªáu su·∫•t n√†o khi s·ª≠ d·ª•ng char(n) so v·ªõi varchar(n). Th·ª±c t·∫ø th√¨ ng∆∞·ª£c l·∫°i. M·ªôt v·∫•n ƒë·ªÅ c·ª• th·ªÉ th∆∞·ªùng x·∫£y ra l√† n·∫øu b·∫°n c·ªë g·∫Øng so s√°nh m·ªôt tr∆∞·ªùng char(n) v·ªõi m·ªôt tham s·ªë m√† driver ƒë√£ ch·ªâ ƒë·ªãnh r√µ r√†ng ki·ªÉu l√† text ho·∫∑c varchar, b·∫°n c√≥ th·ªÉ b·∫•t ng·ªù kh√¥ng th·ªÉ s·ª≠ d·ª•ng index cho ph√©p so s√°nh. ƒêi·ªÅu n√†y c√≥ th·ªÉ kh√≥ g·ª° l·ªói v√¨ n√≥ kh√¥ng hi·ªÉn th·ªã trong c√°c truy v·∫•n th·ªß c√¥ng.

Khi n√†o n√™n d√πng? Kh√¥ng bao gi·ªù.

Kh√¥ng d√πng varchar(n) theo m·∫∑c ƒë·ªãnh:

H√£y c√¢n nh·∫Øc s·ª≠ d·ª•ng varchar (kh√¥ng gi·ªõi h·∫°n ƒë·ªô d√†i) ho·∫∑c text thay th·∫ø.

varchar(n) l√† m·ªôt tr∆∞·ªùng vƒÉn b·∫£n c√≥ ƒë·ªô d√†i thay ƒë·ªïi v√† s·∫Ω g√¢y ra l·ªói n·∫øu b·∫°n c·ªë g·∫Øng ch√®n m·ªôt chu·ªói d√†i h∆°n n k√Ω t·ª± (kh√¥ng ph·∫£i byte) v√†o ƒë√≥.

varchar (kh√¥ng c√≥ (n)) ho·∫∑c text t∆∞∆°ng t·ª±, nh∆∞ng kh√¥ng c√≥ gi·ªõi h·∫°n ƒë·ªô d√†i. N·∫øu b·∫°n ch√®n c√πng m·ªôt chu·ªói v√†o ba ki·ªÉu tr∆∞·ªùng n√†y, ch√∫ng s·∫Ω chi·∫øm ch√≠nh x√°c c√πng m·ªôt l∆∞·ª£ng dung l∆∞·ª£ng v√† b·∫°n s·∫Ω kh√¥ng th·ªÉ ƒëo l∆∞·ªùng b·∫•t k·ª≥ s·ª± kh√°c bi·ªát n√†o v·ªÅ hi·ªáu su·∫•t.

N·∫øu b·∫°n th·ª±c s·ª± c·∫ßn m·ªôt tr∆∞·ªùng vƒÉn b·∫£n c√≥ gi·ªõi h·∫°n ƒë·ªô d√†i, th√¨ varchar(n) r·∫•t t·ªët, nh∆∞ng n·∫øu b·∫°n ch·ªçn m·ªôt ƒë·ªô d√†i t√πy √Ω v√† ch·ªçn varchar(20) cho tr∆∞·ªùng h·ªç, b·∫°n ƒëang m·∫°o hi·ªÉm g√¢y ra l·ªói s·∫£n xu·∫•t trong t∆∞∆°ng lai khi m·ªôt ng∆∞·ªùi c√≥ h·ªç d√†i ƒëƒÉng k√Ω d·ªãch v·ª• c·ªßa b·∫°n.

M·ªôt s·ªë c∆° s·ªü d·ªØ li·ªáu kh√¥ng c√≥ ki·ªÉu c√≥ th·ªÉ ch·ª©a vƒÉn b·∫£n c√≥ ƒë·ªô d√†i t√πy √Ω, ho·∫∑c n·∫øu c√≥ th√¨ n√≥ kh√¥ng ti·ªán l·ª£i, hi·ªáu qu·∫£ ho·∫∑c ƒë∆∞·ª£c h·ªó tr·ª£ t·ªët nh∆∞ varchar(n). Ng∆∞·ªùi d√πng t·ª´ c√°c c∆° s·ªü d·ªØ li·ªáu ƒë√≥ th∆∞·ªùng s·ª≠ d·ª•ng m·ªôt c√°i g√¨ ƒë√≥ nh∆∞ varchar(255) khi h·ªç th·ª±c s·ª± mu·ªën text.

N·∫øu b·∫°n c·∫ßn r√†ng bu·ªôc gi√° tr·ªã trong m·ªôt tr∆∞·ªùng, b·∫°n c√≥ l·∫Ω c·∫ßn m·ªôt c√°i g√¨ ƒë√≥ c·ª• th·ªÉ h∆°n l√† ƒë·ªô d√†i t·ªëi ƒëa - c√≥ th·ªÉ l√† ƒë·ªô d√†i t·ªëi thi·ªÉu, ho·∫∑c m·ªôt t·∫≠p h·ª£p k√Ω t·ª± gi·ªõi h·∫°n - v√† m·ªôt r√†ng bu·ªôc CHECK c√≥ th·ªÉ th·ª±c hi·ªán t·∫•t c·∫£ nh·ªØng ƒëi·ªÅu ƒë√≥ c≈©ng nh∆∞ gi·ªõi h·∫°n ƒë·ªô d√†i chu·ªói t·ªëi ƒëa.

Khi n√†o n√™n d√πng? Khi b·∫°n th·ª±c s·ª± mu·ªën. N·∫øu b·∫°n mu·ªën m·ªôt tr∆∞·ªùng vƒÉn b·∫£n s·∫Ω g√¢y ra l·ªói n·∫øu b·∫°n ch√®n m·ªôt chu·ªói qu√° d√†i v√†o ƒë√≥ v√† b·∫°n kh√¥ng mu·ªën s·ª≠ d·ª•ng m·ªôt r√†ng bu·ªôc CHECK r√µ r√†ng, th√¨ varchar(n) l√† m·ªôt ki·ªÉu ho√†n to√†n t·ªët. Ch·ªâ l√† ƒë·ª´ng s·ª≠ d·ª•ng n√≥ m·ªôt c√°ch t·ª± ƒë·ªông m√† kh√¥ng suy nghƒ©. Ngo√†i ra, ki·ªÉu varchar n·∫±m trong ti√™u chu·∫©n SQL, kh√¥ng gi·ªëng nh∆∞ ki·ªÉu text, v√¨ v·∫≠y n√≥ c√≥ th·ªÉ l√† l·ª±a ch·ªçn t·ªët nh·∫•t ƒë·ªÉ vi·∫øt c√°c ·ª©ng d·ª•ng si√™u di ƒë·ªông.

C√°c Ki·ªÉu D·ªØ li·ªáu Kh√°c (Other Data Types)

Kh√¥ng d√πng money:

Ki·ªÉu d·ªØ li·ªáu money th·ª±c s·ª± kh√¥ng t·ªët l·∫Øm ƒë·ªÉ l∆∞u tr·ªØ c√°c gi√° tr·ªã ti·ªÅn t·ªá. numeric, ho·∫∑c (hi·∫øm khi) integer c√≥ th·ªÉ t·ªët h∆°n.
T·∫°i sao kh√¥ng? R·∫•t nhi·ªÅu l√Ω do:
N√≥ l√† ki·ªÉu fixed-point, ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng s·ªë nguy√™n m√°y, n√™n c√°c ph√©p to√°n v·ªõi n√≥ r·∫•t nhanh. Nh∆∞ng n√≥ kh√¥ng x·ª≠ l√Ω c√°c ph·∫ßn nh·ªè c·ªßa xu (ho·∫∑c t∆∞∆°ng ƒë∆∞∆°ng ·ªü c√°c lo·∫°i ti·ªÅn t·ªá kh√°c), h√†nh vi l√†m tr√≤n c·ªßa n√≥ c√≥ l·∫Ω kh√¥ng ph·∫£i l√† ƒëi·ªÅu b·∫°n mu·ªën.

N√≥ kh√¥ng l∆∞u tr·ªØ ƒë∆°n v·ªã ti·ªÅn t·ªá v·ªõi gi√° tr·ªã, m√† gi·∫£ ƒë·ªãnh r·∫±ng t·∫•t c·∫£ c√°c c·ªôt money ƒë·ªÅu ch·ª©a ƒë∆°n v·ªã ti·ªÅn t·ªá ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh b·ªüi c√†i ƒë·∫∑t locale lc_monetary c·ªßa c∆° s·ªü d·ªØ li·ªáu. N·∫øu b·∫°n thay ƒë·ªïi c√†i ƒë·∫∑t lc_monetary v√¨ b·∫•t k·ª≥ l√Ω do g√¨, t·∫•t c·∫£ c√°c c·ªôt money s·∫Ω ch·ª©a gi√° tr·ªã sai. ƒêi·ªÅu ƒë√≥ c√≥ nghƒ©a l√† n·∫øu b·∫°n ch√®n '$10.00' khi lc_monetary ƒë∆∞·ª£c ƒë·∫∑t th√†nh 'en_US.UTF-8', gi√° tr·ªã b·∫°n truy xu·∫•t c√≥ th·ªÉ l√† '10,00 Lei' ho·∫∑c '¬•1,000' n·∫øu lc_monetary b·ªã thay ƒë·ªïi.

L∆∞u tr·ªØ gi√° tr·ªã d∆∞·ªõi d·∫°ng numeric, c√≥ th·ªÉ v·ªõi ƒë∆°n v·ªã ti·ªÅn t·ªá ƒë∆∞·ª£c s·ª≠ d·ª•ng trong m·ªôt c·ªôt li·ªÅn k·ªÅ, c√≥ th·ªÉ t·ªët h∆°n.

Khi n√†o n√™n d√πng? N·∫øu b·∫°n ch·ªâ l√†m vi·ªác v·ªõi m·ªôt lo·∫°i ti·ªÅn t·ªá duy nh·∫•t, kh√¥ng x·ª≠ l√Ω c√°c ph·∫ßn nh·ªè c·ªßa xu v√† ch·ªâ th·ª±c hi·ªán ph√©p c·ªông v√† ph√©p tr·ª´, th√¨ money c√≥ th·ªÉ l√† l·ª±a ch·ªçn ph√π h·ª£p.

Kh√¥ng d√πng serial:

ƒê·ªëi v·ªõi c√°c ·ª©ng d·ª•ng m·ªõi, n√™n s·ª≠ d·ª•ng identity columns (c·ªôt ƒë·ªãnh danh) thay th·∫ø.

C√°c ki·ªÉu serial c√≥ m·ªôt s·ªë h√†nh vi k·ª≥ l·∫° khi·∫øn vi·ªác qu·∫£n l√Ω schema, ph·ª• thu·ªôc v√† quy·ªÅn tr·ªü n√™n r∆∞·ªùm r√† kh√¥ng c·∫ßn thi·∫øt.

Khi n√†o n√™n d√πng? N·∫øu b·∫°n c·∫ßn h·ªó tr·ª£ c√°c phi√™n b·∫£n PostgreSQL c≈© h∆°n phi√™n b·∫£n 10. Trong m·ªôt s·ªë k·∫øt h·ª£p v·ªõi k·∫ø th·ª´a b·∫£ng (nh∆∞ng h√£y xem ph·∫ßn ƒë√≥). N√≥i chung, n·∫øu b·∫°n b·∫±ng c√°ch n√†o ƒë√≥ s·ª≠ d·ª•ng c√πng m·ªôt sequence cho nhi·ªÅu b·∫£ng, m·∫∑c d√π trong nh·ªØng tr∆∞·ªùng h·ª£p ƒë√≥, vi·ªác khai b√°o r√µ r√†ng c√≥ th·ªÉ ƒë∆∞·ª£c ∆∞u ti√™n h∆°n so v·ªõi c√°c ki·ªÉu serial.

X√°c th·ª±c (Authentication)

Kh√¥ng d√πng x√°c th·ª±c trust qua TCP/IP (host, hostssl):

ƒê·∫∑c bi·ªát kh√¥ng ƒë·∫∑t m·ªôt d√≤ng nh∆∞ sau trong t·ªáp pg_hba.conf c·ªßa b·∫°n:
host all all 0.0.0.0/0 trust
ƒêi·ªÅu n√†y cho ph√©p b·∫•t k·ª≥ ai tr√™n Internet x√°c th·ª±c v·ªõi t∆∞ c√°ch b·∫•t k·ª≥ ng∆∞·ªùi d√πng PostgreSQL n√†o trong cluster c·ªßa b·∫°n, bao g·ªìm c·∫£ superuser PostgreSQL.

C√≥ m·ªôt danh s√°ch c√°c ph∆∞∆°ng ph√°p x√°c th·ª±c t·ªët h∆°n ƒë·ªÉ thi·∫øt l·∫≠p k·∫øt n·ªëi t·ª´ xa ƒë·∫øn PostgreSQL. Vi·ªác thi·∫øt l·∫≠p ph∆∞∆°ng ph√°p x√°c th·ª±c d·ª±a tr√™n m·∫≠t kh·∫©u kh√° d·ªÖ d√†ng, v·ªõi khuy·∫øn ngh·ªã l√† scram-sha-256 c√≥ s·∫µn trong PostgreSQL 10 tr·ªü l√™n.

T·∫°i sao kh√¥ng? T√†i li·ªáu h∆∞·ªõng d·∫´n n√≥i r·∫±ng x√°c th·ª±c trust ch·ªâ ph√π h·ª£p cho c√°c k·∫øt n·ªëi TCP/IP n·∫øu b·∫°n tin t∆∞·ªüng m·ªçi ng∆∞·ªùi d√πng tr√™n m·ªçi m√°y ƒë∆∞·ª£c ph√©p k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß b·ªüi c√°c d√≤ng pg_hba.conf ch·ªâ ƒë·ªãnh trust. Hi·∫øm khi h·ª£p l√Ω khi s·ª≠ d·ª•ng trust cho b·∫•t k·ª≥ k·∫øt n·ªëi TCP/IP n√†o kh√°c ngo√†i c√°c k·∫øt n·ªëi t·ª´ localhost (127.0.0.1). V·ªõi x√°c th·ª±c trust, b·∫•t k·ª≥ ng∆∞·ªùi d√πng n√†o c≈©ng c√≥ th·ªÉ t·ª± nh·∫≠n m√¨nh l√† ng∆∞·ªùi d√πng kh√°c v√† PostgreSQL s·∫Ω tin t∆∞·ªüng ƒëi·ªÅu ƒë√≥. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† ai ƒë√≥ c√≥ th·ªÉ t·ª± nh·∫≠n l√† t√†i kho·∫£n superuser postgres v√† PostgreSQL s·∫Ω ch·∫•p nh·∫≠n y√™u c·∫ßu ƒë√≥ v√† cho ph√©p h·ªç ƒëƒÉng nh·∫≠p. H∆°n n·ªØa, c≈©ng kh√¥ng n√™n cho ph√©p s·ª≠ d·ª•ng x√°c th·ª±c trust tr√™n c√°c k·∫øt n·ªëi socket UNIX c·ª•c b·ªô trong m√¥i tr∆∞·ªùng production, v√¨ b·∫•t k·ª≥ ai c√≥ quy·ªÅn truy c·∫≠p v√†o instance ƒëang ch·∫°y PostgreSQL ƒë·ªÅu c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch b·∫•t k·ª≥ ng∆∞·ªùi d√πng n√†o.

Khi n√†o n√™n d√πng? C√¢u tr·∫£ l·ªùi ng·∫Øn g·ªçn l√† kh√¥ng bao gi·ªù. C√¢u tr·∫£ l·ªùi d√†i h∆°n l√† c√≥ m·ªôt v√†i tr∆∞·ªùng h·ª£p m√† x√°c th·ª±c trust c√≥ th·ªÉ ph√π h·ª£p: ch·∫°y th·ª≠ nghi·ªám tr√™n m√°y ch·ªß PostgreSQL nh∆∞ m·ªôt ph·∫ßn c·ªßa CI/CD job tr√™n m·ªôt m·∫°ng ƒë√°ng tin c·∫≠y; l√†m vi·ªác tr√™n m√°y ph√°t tri·ªÉn c·ª•c b·ªô c·ªßa b·∫°n, nh∆∞ng ch·ªâ cho ph√©p c√°c k·∫øt n·ªëi TCP/IP qua localhost. Nh∆∞ng b·∫°n n√™n xem li·ªáu c√°c ph∆∞∆°ng ph√°p thay th·∫ø c√≥ ph√π h·ª£p h∆°n v·ªõi b·∫°n kh√¥ng. V√≠ d·ª•, tr√™n c√°c h·ªá th·ªëng d·ª±a tr√™n UNIX, b·∫°n c√≥ th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√¥i tr∆∞·ªùng ph√°t tri·ªÉn c·ª•c b·ªô c·ªßa m√¨nh b·∫±ng c√°ch s·ª≠ d·ª•ng x√°c th·ª±c peer.

- 17 M·ªôt Hypertable l√† m·ªôt b·∫£ng ·∫£o (virtual table) ho·∫∑c m·ªôt l·ªõp tr·ª´u t∆∞·ª£ng (abstraction layer) n·∫±m ph√≠a tr√™n nhi·ªÅu b·∫£ng PostgreSQL th√¥ng th∆∞·ªùng kh√°c, ƒë∆∞·ª£c g·ªçi l√† Chunks.
ƒê√¢y l√† c√°ch n√≥ ho·∫°t ƒë·ªông v√† √Ω nghƒ©a c·ªßa n√≥:
Giao di·ªán ng∆∞·ªùi d√πng (User Interface):
ƒê·ªëi v·ªõi ng∆∞·ªùi d√πng ho·∫∑c ·ª©ng d·ª•ng, b·∫°n t∆∞∆°ng t√°c v·ªõi Hypertable gi·ªëng h·ªát nh∆∞ b·∫°n t∆∞∆°ng t√°c v·ªõi m·ªôt b·∫£ng PostgreSQL th√¥ng th∆∞·ªùng. B·∫°n th·ª±c hi·ªán c√°c l·ªánh INSERT, UPDATE, DELETE, SELECT tr·ª±c ti·∫øp tr√™n Hypertable.
Ph√¢n v√πng t·ª± ƒë·ªông (Automatic Partitioning):
"Ph√≠a sau h·∫≠u tr∆∞·ªùng", TimescaleDB t·ª± ƒë·ªông ph√¢n v√πng (partition) d·ªØ li·ªáu c·ªßa Hypertable th√†nh nhi·ªÅu b·∫£ng con v·∫≠t l√Ω nh·ªè h∆°n g·ªçi l√† Chunks.
Vi·ªác ph√¢n v√πng n√†y ch·ªß y·∫øu d·ª±a tr√™n c·ªôt th·ªùi gian (time column) m√† b·∫°n ch·ªâ ƒë·ªãnh khi t·∫°o Hypertable. M·ªói Chunk s·∫Ω ch·ª©a d·ªØ li·ªáu cho m·ªôt kho·∫£ng th·ªùi gian c·ª• th·ªÉ (v√≠ d·ª•: 7 ng√†y, 1 th√°ng).
B·∫°n c≈©ng c√≥ th·ªÉ ph√¢n v√πng th√™m theo m·ªôt ho·∫∑c nhi·ªÅu c·ªôt kh√°c (v√≠ d·ª•: device_id, location), g·ªçi l√† ph√¢n v√πng kh√¥ng gian (space partitioning), ƒë·ªÉ t·ªëi ∆∞u h√≥a h∆°n n·ªØa.
Chunks l√† g√¨?
M·ªói Chunk l√† m·ªôt b·∫£ng PostgreSQL ti√™u chu·∫©n th·ª±c s·ª±, l∆∞u tr·ªØ m·ªôt ph·∫ßn d·ªØ li·ªáu c·ªßa Hypertable.
TimescaleDB t·ª± ƒë·ªông t·∫°o c√°c Chunk m·ªõi khi c·∫ßn thi·∫øt khi d·ªØ li·ªáu m·ªõi ƒë∆∞·ª£c ch√®n v√†o.
M·ªói Chunk c√≥ c√°c r√†ng bu·ªôc (constraints) ri√™ng ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu trong ƒë√≥ thu·ªôc ƒë√∫ng kho·∫£ng th·ªùi gian (v√† kh√¥ng gian, n·∫øu c√≥).
M·ªói Chunk c√≥ th·ªÉ c√≥ c√°c ch·ªâ m·ª•c (indexes) ri√™ng, th∆∞·ªùng ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o d·ª±a tr√™n c√°c ch·ªâ m·ª•c c·ªßa Hypertable.
L·ª£i √≠ch c·ªßa vi·ªác s·ª≠ d·ª•ng Hypertables (v√† Chunks):
Hi·ªáu nƒÉng truy v·∫•n (Query Performance): Khi b·∫°n truy v·∫•n Hypertable v·ªõi ƒëi·ªÅu ki·ªán l·ªçc theo th·ªùi gian (v√≠ d·ª•: WHERE time > '2023-10-26' AND time < '2023-10-27'), TimescaleDB ch·ªâ c·∫ßn qu√©t c√°c Chunks c√≥ ch·ª©a d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√≥, b·ªè qua h√†ng t·ª∑ b·∫£n ghi ti·ªÅm nƒÉng trong c√°c Chunks kh√°c. ƒêi·ªÅu n√†y l√†m tƒÉng t·ªëc ƒë·ªô truy v·∫•n l√™n ƒë√°ng k·ªÉ so v·ªõi vi·ªác qu√©t m·ªôt b·∫£ng kh·ªïng l·ªì duy nh·∫•t.
Hi·ªáu nƒÉng ghi (Ingest Performance): Vi·ªác ghi d·ªØ li·ªáu v√†o c√°c Chunks nh·ªè h∆°n th∆∞·ªùng nhanh h∆°n so v·ªõi vi·ªác ghi v√†o m·ªôt b·∫£ng l·ªõn duy nh·∫•t, ƒë·∫∑c bi·ªát l√† khi c√°c ch·ªâ m·ª•c c≈©ng tr·ªü n√™n l·ªõn.
Kh·∫£ nƒÉng m·ªü r·ªông (Scalability): Cho ph√©p qu·∫£n l√Ω hi·ªáu qu·∫£ c√°c t·∫≠p d·ªØ li·ªáu c·ª±c l·ªõn (h√†ng terabytes ho·∫∑c petabytes) m√† kh√¥ng l√†m gi·∫£m hi·ªáu nƒÉng.
Qu·∫£n l√Ω d·ªØ li·ªáu (Data Management):
X√≥a d·ªØ li·ªáu c≈©: Vi·ªác x√≥a d·ªØ li·ªáu c≈© tr·ªü n√™n c·ª±c k·ª≥ nhanh ch√≥ng v√† hi·ªáu qu·∫£. Thay v√¨ ch·∫°y l·ªánh DELETE t·ªën k√©m t√†i nguy√™n tr√™n m·ªôt b·∫£ng l·ªõn, b·∫°n ch·ªâ c·∫ßn th·∫£ (drop) to√†n b·ªô Chunk c≈© b·∫±ng l·ªánh drop_chunks(). Vi·ªác n√†y g·∫ßn nh∆∞ t·ª©c th·ªùi v√† kh√¥ng g√¢y ph√¢n m·∫£nh b·∫£ng.
N√©n d·ªØ li·ªáu (Compression): TimescaleDB cho ph√©p n√©n d·ªØ li·ªáu ·ªü c·∫•p ƒë·ªô Chunk. B·∫°n c√≥ th·ªÉ thi·∫øt l·∫≠p ch√≠nh s√°ch ƒë·ªÉ t·ª± ƒë·ªông n√©n c√°c Chunks c≈© nh·∫±m ti·∫øt ki·ªám dung l∆∞·ª£ng l∆∞u tr·ªØ m√† v·∫´n c√≥ th·ªÉ truy v·∫•n ƒë∆∞·ª£c.
Sao l∆∞u/Ph·ª•c h·ªìi: C√≥ th·ªÉ th·ª±c hi·ªán c√°c thao t√°c qu·∫£n l√Ω ·ªü c·∫•p ƒë·ªô Chunk.
T·∫°o Hypertable:
B·∫°n b·∫Øt ƒë·∫ßu b·∫±ng c√°ch t·∫°o m·ªôt b·∫£ng PostgreSQL th√¥ng th∆∞·ªùng.
Sau ƒë√≥, b·∫°n s·ª≠ d·ª•ng h√†m create_hypertable() do TimescaleDB cung c·∫•p ƒë·ªÉ bi·∫øn b·∫£ng ƒë√≥ th√†nh Hypertable, ch·ªâ ƒë·ªãnh b·∫£ng n√†o v√† c·ªôt th·ªùi gian n√†o s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ph√¢n v√πng.
V√≠ d·ª•: SELECT create_hypertable('sensor_data', 'ts');